name: Smoke Tests (Scheduled)

on:
  schedule:
    # LA time 00:00, 06:00, 12:00, 18:00 => UTC 08:00, 14:00, 20:00, 02:00
    # DakikayÄ± 00 yerine 17 seÃ§tim (load/delay riskini azaltmak iÃ§in)
    - cron: "17 2,8,14,20 * * *"
  workflow_dispatch: {}  # Manuel trigger iÃ§in

jobs:
  security-smoke:
    name: Security Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run Security Smoke Test
        working-directory: ./backend
        env:
          API_URL: ${{ secrets.API_URL }}
          SAFE_TEST_MODE: "true"
        run: node scripts/security-smoke-test.js

  functional-test:
    name: Functional Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run Functional Test
        working-directory: ./backend
        env:
          API_URL: ${{ secrets.API_URL }}
        run: node scripts/functional-test.js

  assistant-test:
    name: Assistant & Conversation Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run Assistant Test
        working-directory: ./backend
        env:
          API_URL: ${{ secrets.API_URL }}
        run: node scripts/assistant-test.js

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [security-smoke, functional-test, assistant-test]
    if: failure()

    steps:
      - name: Send Email on Failure
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: 'ðŸš¨ Smoke Tests Failed - ${{ github.workflow }}'
          to: nurettinerzen@gmail.com
          from: GitHub Actions
          body: |
            Smoke tests failed for scheduled run.

            Workflow: ${{ github.workflow }}
            Time: ${{ github.event.schedule }}
            Commit: ${{ github.sha }}

            Failed jobs:
            ${{ needs.security-smoke.result }}
            ${{ needs.functional-test.result }}
            ${{ needs.assistant-test.result }}

            View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
