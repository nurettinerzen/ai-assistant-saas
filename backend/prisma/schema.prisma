generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  Int          @id @default(autoincrement())
  email               String       @unique
  password            String
  name                String?
  role                UserRole     @default(STAFF)
  businessId          Int
  invitedById         Int?
  invitedAt           DateTime?
  acceptedAt          DateTime?
  onboardingCompleted Boolean      @default(false)
  emailVerified       Boolean      @default(false)
  emailVerifiedAt     DateTime?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  business            Business     @relation(fields: [businessId], references: [id])
  invitedBy           User?        @relation("UserInvitations", fields: [invitedById], references: [id])
  invitedUsers        User[]       @relation("UserInvitations")
  sentInvitations     Invitation[] @relation("InvitedByUser")
  verificationTokens  EmailVerificationToken[]

  @@index([businessId])
  @@index([email])
}

model Invitation {
  id          Int       @id @default(autoincrement())
  email       String
  businessId  Int
  role        UserRole
  token       String    @unique
  invitedById Int
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime  @default(now())
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invitedBy   User      @relation("InvitedByUser", fields: [invitedById], references: [id])

  @@index([businessId])
  @@index([token])
  @@index([email])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Business {
  id                      Int                     @id @default(autoincrement())
  name                    String
  language                String                  @default("TR")  // Uygulama dili (TR, EN, PR, DE, ES, FR...)
  country                 String                  @default("TR")  // Bölge kodu (TR, BR, US, DE...)
  currency                String                  @default("TRY") // Para birimi (TRY, BRL, USD, EUR...)
  timezone                String                  @default("Europe/Istanbul")
  phoneNumbers            String[]                @default([])
  vapiPhoneNumber         String?
  vapiAssistantId         String?
  vapiPitch               Float?                  @default(1.0)
  vapiSpeed               Float?                  @default(1.0)
  vapiTone                VoiceTone?              @default(PROFESSIONAL)
  vapiVoiceGender         VoiceGender?            @default(MALE)
  vapiVoiceId             String?                 @default("male-1-professional")
  businessType            BusinessType            @default(OTHER)
  customGreeting          String?
  customInstructions      String?
  bookingDuration         Int?                    @default(30)
  bufferTime              Int?                    @default(15)
  googleSheetId           String?
  googleSheetLastSync     DateTime?
  googleSheetName         String?
  // Google Sheets OAuth fields
  googleSheetsAccessToken   String?   @db.Text
  googleSheetsRefreshToken  String?   @db.Text
  googleSheetsTokenExpiry   DateTime?
  googleSheetsConnected     Boolean   @default(false)
  whatsappPhoneNumberId   String?
  whatsappAccessToken     String?
  whatsappVerifyToken     String?
  whatsappWebhookUrl      String?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  ownerPhone              String?
  ownerWhatsApp           String?
  aiTrainings             AiTraining[]
  appointments            Appointment[]
  assistants              Assistant[]
  bookingIntegration      BookingIntegration?
  businessHours           BusinessHours?
  callLogs                CallLog[]
  erpIntegration          ErpIntegration?
  integrations            Integration[]
  knowledgeBase           KnowledgeBase[]
  provisionedPhoneNumbers PhoneNumber[]           @relation("BusinessPhoneNumbers")
  products                Product[]
  reservationIntegration  ReservationIntegration?
  shippingInfos           ShippingInfo[]
  subscription            Subscription?
  users                   User[]
  emailIntegration        EmailIntegration?
  emailThreads            EmailThread[]
  emailDrafts             EmailDraft[]
  webhookConfig           WebhookConfig?
  invitations             Invitation[]
  creditPurchases         CreditPurchase[]
  usageLogs               UsageLog[]
  crmWebhook              CrmWebhook?
  crmOrders               CrmOrder[]
  crmStocks               CrmStock[]
  crmTickets              CrmTicket[]
  batchCalls              BatchCall[]

  @@index([name])
}

model Assistant {
  id                  String        @id @default(cuid())
  businessId          Int
  name                String
  voiceId             String
  systemPrompt        String        @db.Text
  model               String        @default("gpt-4")
  vapiAssistantId     String?       @unique  // DEPRECATED: Use elevenLabsAgentId
  elevenLabsAgentId   String?       @unique  // 11Labs Conversational AI Agent ID
  voiceProvider       String        @default("elevenlabs")  // "elevenlabs" or "vapi" for transition
  isActive            Boolean       @default(true)
  timezone            String?       // Business timezone for date/time context
  firstMessage        String?       // Custom first message
  tone                String        @default("professional")  // "friendly" or "professional"
  customNotes         String?       @db.Text                  // Business-specific notes
  callDirection       String        @default("inbound")       // "inbound" or "outbound"
  callPurpose         String?                                 // For outbound: "collection", "reminder", "survey", "info", "custom"
  dynamicVariables    String[]      @default([])              // Dynamic variable names for outbound calls
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  business            Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  phoneNumbers        PhoneNumber[]
  batchCalls          BatchCall[]

  @@index([businessId])
  @@index([isActive])
  @@index([callDirection])
}

model PhoneNumber {
  id                      String        @id @default(cuid())
  businessId              Int
  phoneNumber             String        @unique
  countryCode             String
  provider                PhoneProvider
  vapiPhoneId             String?       @unique  // DEPRECATED: Use elevenLabsPhoneId
  elevenLabsPhoneId       String?       @unique  // 11Labs phone number ID
  netgsmNumberId          String?
  sipUsername             String?
  sipPassword             String?
  sipServer               String?
  assistantId             String?
  status                  PhoneStatus   @default(ACTIVE)
  monthlyCost             Float
  nextBillingDate         DateTime?
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  assistant               Assistant?    @relation(fields: [assistantId], references: [id])
  business                Business      @relation("BusinessPhoneNumbers", fields: [businessId], references: [id], onDelete: Cascade)
  batchCalls              BatchCall[]

  @@index([businessId])
  @@index([phoneNumber])
  @@index([status])
}

model Subscription {
  id                      Int                @id @default(autoincrement())
  businessId              Int                @unique
  plan                    SubscriptionPlan   @default(FREE)
  status                  SubscriptionStatus @default(TRIAL)
  paymentProvider         String?            @default("stripe") // "stripe" or "iyzico"
  // Stripe fields
  stripeCustomerId        String?
  stripeSubscriptionId    String?            @unique
  stripePriceId           String?
  // iyzico fields
  iyzicoCustomerId        String?
  iyzicoSubscriptionId    String?            @unique
  iyzicoReferenceCode     String?            @unique
  iyzicoPricingPlanId     String?
  iyzicoCardToken         String?
  iyzicoPaymentId         String?            // For checkout form payments
  // Pending subscription fields (for callback)
  pendingSubscriptionToken String?
  pendingPlanId           String?
  // Common fields
  currentPeriodStart      DateTime?
  currentPeriodEnd        DateTime?
  cancelAtPeriodEnd       Boolean            @default(false)
  minutesUsed             Int                @default(0)
  callsThisMonth          Int                @default(0)
  assistantsCreated       Int                @default(0)
  phoneNumbersUsed        Int                @default(0)
  minutesLimit            Int                @default(0)
  callsLimit              Int                @default(0)
  assistantsLimit         Int                @default(0)
  phoneNumbersLimit       Int                @default(0)

  // Kredi sistemi (YENİ)
  creditMinutes           Int                @default(0)    // Satın alınan toplam kredi dakikaları
  creditMinutesUsed       Int                @default(0)    // Krediden kullanılan dakikalar

  // Aşım sistemi (YENİ)
  overageMinutes          Int                @default(0)    // Bu ay aşım dakikaları
  overageRate             Float              @default(12)   // TL/dk aşım ücreti
  overageLimit            Int                @default(50)   // Max aşım limiti (dakika)

  // Uyarı durumları (YENİ)
  packageWarningAt80      Boolean            @default(false)  // Paket %80 uyarısı gönderildi mi
  creditWarningAt80       Boolean            @default(false)  // Kredi %80 uyarısı gönderildi mi
  overageLimitReached     Boolean            @default(false)  // Aşım limiti aşıldı mı

  // Concurrent call limitleri (YENİ)
  concurrentLimit         Int                @default(1)      // Max eşzamanlı çağrı limiti
  activeCalls             Int                @default(0)      // Şu anki aktif çağrı sayısı

  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  business                Business           @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([plan])
  @@index([status])
  @@index([paymentProvider])
}

model CallLog {
  id                Int      @id @default(autoincrement())
  businessId        Int
  callId            String   @unique
  callerId          String?
  duration          Int?
  status            String
  transcript        Json?    // Array of {speaker, text, timestamp}
  transcriptText    String?  @db.Text // Plain text for search
  recordingUrl      String?  @db.Text
  recordingDuration Int?     // Duration in seconds
  intent            String?
  sentiment         String?  // 'positive', 'neutral', 'negative'
  sentimentScore    Float?   // 0.0 to 1.0
  summary           String?  @db.Text
  keyPoints         String[] @default([])
  keyTopics         String[] @default([]) // ['appointment', 'pricing', 'availability']
  actionItems       String[] @default([]) // ['Schedule follow-up', 'Send email']
  taskCompleted     Boolean?
  followUpNeeded    Boolean?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  business          Business @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([callId])
  @@index([createdAt])
  @@index([status])
}

model Integration {
  id          Int                   @id @default(autoincrement())
  businessId  Int
  type        IntegrationType
  credentials Json
  isActive    Boolean               @default(true)
  syncEnabled Boolean               @default(true)
  lastSync    DateTime?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  connected   Boolean?              @default(false)
  relevantFor BusinessType[]        @default([])
  priority    IntegrationPriority?  @default(OPTIONAL)
  business    Business              @relation(fields: [businessId], references: [id])

  @@unique([businessId, type])
  @@index([businessId])
  @@index([type])
}

model BusinessHours {
  id         Int      @id @default(autoincrement())
  businessId Int      @unique
  monday     Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  tuesday    Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  wednesday  Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  thursday   Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  friday     Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  saturday   Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": true}")
  sunday     Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": true}")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id])
}

model Appointment {
  id              Int               @id @default(autoincrement())
  businessId      Int
  customerName    String
  customerPhone   String
  customerEmail   String?
  appointmentDate DateTime
  duration        Int
  serviceType     String?
  notes           String?
  status          AppointmentStatus @default(PENDING)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  business        Business          @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([appointmentDate])
  @@index([status])
}

model Product {
  id                Int            @id @default(autoincrement())
  businessId        Int
  sku               String
  name              String
  description       String?
  price             Float
  category          String?
  imageUrl          String?
  stockQuantity     Int            @default(0)
  lowStockThreshold Int            @default(10)
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  inventoryLogs     InventoryLog[]
  business          Business       @relation(fields: [businessId], references: [id])

  @@unique([businessId, sku])
  @@index([businessId])
  @@index([category])
  @@index([isActive])
}

model InventoryLog {
  id             Int                 @id @default(autoincrement())
  productId      Int
  changeType     InventoryChangeType
  quantityChange Int
  newQuantity    Int
  note           String?
  createdAt      DateTime            @default(now())
  product        Product             @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([createdAt])
}

model ShippingInfo {
  id                Int             @id @default(autoincrement())
  businessId        Int
  orderId           String
  trackingNumber    String
  carrier           ShippingCarrier
  status            ShippingStatus  @default(PENDING)
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  customerPhone     String?
  customerEmail     String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  business          Business        @relation(fields: [businessId], references: [id])

  @@unique([businessId, orderId])
  @@index([businessId])
  @@index([trackingNumber])
  @@index([status])
}

model AiTraining {
  id           Int      @id @default(autoincrement())
  businessId   Int
  title        String
  instructions String
  category     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([isActive])
}

model KnowledgeBase {
  id              String          @id @default(cuid())
  businessId      Int
  type            KnowledgeType
  title           String
  content         String?
  fileName        String?
  fileSize        Int?
  mimeType        String?
  filePath        String?
  url             String?
  crawlDepth      Int?
  pageCount       Int?
  lastCrawled     DateTime?
  question        String?
  answer          String?
  category        String?
  elevenLabsDocId String?         // 11Labs knowledge base document ID
  status          KnowledgeStatus @default(PROCESSING)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  business        Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([type])
  @@index([status])
}

model ErpIntegration {
  id           Int       @id @default(autoincrement())
  businessId   Int       @unique
  type         ErpType
  apiEndpoint  String?
  apiKey       String?
  username     String?
  password     String?
  companyCode  String?
  syncEnabled  Boolean   @default(true)
  syncInterval Int       @default(60)
  lastSync     DateTime?
  realtimeMode Boolean   @default(false)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  business     Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model ReservationIntegration {
  id            Int                 @id @default(autoincrement())
  businessId    Int                 @unique
  platform      ReservationPlatform
  apiKey        String?
  apiSecret     String?
  restaurantId  String?
  syncEnabled   Boolean             @default(true)
  autoSync      Boolean             @default(true)
  lastSync      DateTime?
  webhookUrl    String?
  webhookSecret String?
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  business      Business            @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model BookingIntegration {
  id            Int             @id @default(autoincrement())
  businessId    Int             @unique
  platform      BookingPlatform
  apiKey        String?
  shopId        String?
  accessToken   String?
  syncEnabled   Boolean         @default(true)
  bidirectional Boolean         @default(false)
  lastSync      DateTime?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  business      Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

enum UserRole {
  OWNER
  MANAGER
  STAFF
}

enum BusinessType {
  RESTAURANT
  SALON
  ECOMMERCE
  CLINIC
  SERVICE
  OTHER
}

enum VoiceGender {
  MALE
  FEMALE
}

enum VoiceTone {
  PROFESSIONAL
  FRIENDLY
  WARM
  ENERGETIC
}

enum PhoneProvider {
  VAPI       // DEPRECATED: Use ELEVENLABS
  ELEVENLABS // 11Labs Conversational AI
  NETGSM
  TWILIO
  CUSTOM
}

enum PhoneStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum SubscriptionPlan {
  FREE
  STARTER     // Yeni: Başlangıç paketi (eskiden BASIC)
  PRO         // Yeni: Profesyonel paket
  ENTERPRISE
  BASIC       // Deprecated: eski paket, geriye dönük uyumluluk için
  PROFESSIONAL // Deprecated: eski paket, geriye dönük uyumluluk için
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
}

enum IntegrationType {
  OPENTABLE
  CALENDLY
  SHOPIFY
  STRIPE_PAYMENTS
  TWILIO_SMS
  SENDGRID_EMAIL
  GOOGLE_CALENDAR
  HUBSPOT
  ZAPIER
  WHATSAPP
  GOOGLE_SHEETS
  SLACK
  SALESFORCE
  WOOCOMMERCE
  TOAST_POS
  SQUARE
  SIMPLEPRACTICE
  ZOCDOC
  BOOKSY
  FRESHA
  SHIPSTATION
  KLAVIYO
  MAILCHIMP
  YURTICI_KARGO
  ARAS_KARGO
  MNG_KARGO
  TRENDYOL
  PARASUT
  IYZICO
  IKAS
  IDEASOFT
  TICIMAX
  CUSTOM
}

enum IntegrationPriority {
  ESSENTIAL
  RECOMMENDED
  OPTIONAL
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum InventoryChangeType {
  SALE
  RESTOCK
  ADJUSTMENT
  RETURN
}

enum ShippingCarrier {
  UPS
  FEDEX
  USPS
  DHL
  YURTICI
  ARAS
  MNG
  PTT
  SURAT
  OTHER
}

enum ShippingStatus {
  PENDING
  SHIPPED
  IN_TRANSIT
  DELIVERED
  RETURNED
}

enum KnowledgeType {
  DOCUMENT
  FAQ
  URL
}

enum KnowledgeStatus {
  PROCESSING
  ACTIVE
  FAILED
}

enum ErpType {
  MIKRO
  SAP
  NETSUITE
  ODOO
  CUSTOM
}

enum ReservationPlatform {
  YELP
  OPENTABLE
  RESY
  GOOGLE_RESERVE
  CUSTOM
}

enum BookingPlatform {
  BOOKSY
  SQUARE_APPOINTMENTS
  FRESHA
  VAGARO
  SCHEDULICITY
  CUSTOM
}

// ==================== EMAIL CHANNEL MODELS ====================

enum EmailProvider {
  GMAIL
  OUTLOOK
}

enum EmailThreadStatus {
  PENDING_REPLY
  DRAFT_READY
  REPLIED
  CLOSED
  NO_REPLY_NEEDED  // For automated/marketing emails
}

enum EmailMessageDirection {
  INBOUND
  OUTBOUND
}

enum EmailMessageStatus {
  RECEIVED
  DRAFT
  APPROVED
  SENT
}

enum EmailDraftStatus {
  PENDING_REVIEW
  APPROVED
  SENT
  REJECTED
}

model EmailIntegration {
  id                   Int                      @id @default(autoincrement())
  businessId           Int                      @unique
  provider             EmailProvider
  email                String                   // Connected email address
  credentials          Json                     // access_token, refresh_token, expiry
  connected            Boolean                  @default(true)
  lastSyncedAt         DateTime?
  // Style Learning fields
  styleProfile         Json?                    // User's writing style profile
  styleAnalysisStatus  StyleAnalysisStatus      @default(PENDING)
  styleAnalyzedAt      DateTime?
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  business             Business                 @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([provider])
}

enum StyleAnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Email Sender Cache for Smart Filtering
model EmailSenderCache {
  id             String              @id @default(cuid())
  businessId     Int
  emailAddress   String              // Sender's email address
  classification EmailClassification
  classifiedBy   ClassificationSource
  overriddenAt   DateTime?           // If user manually overrode the classification
  createdAt      DateTime            @default(now())
  expiresAt      DateTime            // 30 days from creation

  @@unique([businessId, emailAddress])
  @@index([businessId])
  @@index([emailAddress])
  @@index([expiresAt])
}

enum EmailClassification {
  PERSONAL
  AUTOMATED
}

enum ClassificationSource {
  HEURISTIC
  AI
  USER_OVERRIDE
}

model EmailThread {
  id            String            @id @default(cuid())
  businessId    Int
  threadId      String            // Gmail/Outlook thread ID
  subject       String
  customerEmail String
  customerName  String?
  status        EmailThreadStatus @default(PENDING_REPLY)
  lastMessageAt DateTime
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  business      Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  messages      EmailMessage[]
  drafts        EmailDraft[]

  @@unique([businessId, threadId])
  @@index([businessId])
  @@index([status])
  @@index([lastMessageAt])
}

model EmailMessage {
  id           String                @id @default(cuid())
  threadId     String
  messageId    String                // Gmail/Outlook message ID
  direction    EmailMessageDirection
  fromEmail    String
  fromName     String?
  toEmail      String
  subject      String
  bodyText     String?               @db.Text
  bodyHtml     String?               @db.Text
  attachments  Json?                 // [{name, size, mimeType}]
  isDraft      Boolean               @default(false)
  status       EmailMessageStatus    @default(RECEIVED)
  sentAt       DateTime?
  receivedAt   DateTime?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  thread       EmailThread           @relation(fields: [threadId], references: [id], onDelete: Cascade)
  drafts       EmailDraft[]

  @@unique([threadId, messageId])
  @@index([threadId])
  @@index([direction])
  @@index([status])
}

model EmailDraft {
  id               String           @id @default(cuid())
  messageId        String?          // Which message this is replying to
  threadId         String
  businessId       Int
  generatedContent String           @db.Text  // AI-generated draft
  editedContent    String?          @db.Text  // User's edited version
  status           EmailDraftStatus @default(PENDING_REVIEW)
  reviewedAt       DateTime?
  reviewedBy       Int?             // User ID who reviewed
  sentAt           DateTime?
  sentMessageId    String?          // ID of sent message
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  thread           EmailThread      @relation(fields: [threadId], references: [id], onDelete: Cascade)
  message          EmailMessage?    @relation(fields: [messageId], references: [id])
  business         Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([businessId])
  @@index([status])
}

// ============================================================================
// WEBHOOK INTEGRATION TABLES
// ============================================================================

model WebhookConfig {
  id            Int       @id @default(autoincrement())
  businessId    Int       @unique
  webhookSecret String    @unique @default(cuid())
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([webhookSecret])
}

model WebhookLog {
  id          Int       @id @default(autoincrement())
  businessId  Int
  type        String    // order, inventory, shipment, custom
  action      String?   // created, updated, deleted
  payload     Json
  status      String    @default("received") // received, processed, failed
  errorMessage String?
  processedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([businessId])
  @@index([type])
  @@index([createdAt])
}

model WebhookOrder {
  id              Int       @id @default(autoincrement())
  businessId      Int
  externalId      String
  customerName    String?
  customerPhone   String?
  customerEmail   String?
  status          String    @default("pending")
  statusText      String?
  totalAmount     Float?
  currency        String    @default("TRY")
  items           Json?
  trackingNumber  String?
  trackingCarrier String?
  trackingUrl     String?
  source          String    @default("webhook") // zapier, make, custom
  rawPayload      Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([businessId, externalId])
  @@index([businessId])
  @@index([customerPhone])
  @@index([customerEmail])
  @@index([externalId])
}

model WebhookInventory {
  id          Int       @id @default(autoincrement())
  businessId  Int
  externalId  String?
  productName String
  sku         String?
  stock       Int       @default(0)
  source      String    @default("webhook")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([businessId, sku])
  @@index([businessId])
  @@index([sku])
}

// ============================================================================
// BATCH CALL / COLLECTION CAMPAIGN TABLES
// ============================================================================

enum CampaignChannel {
  PHONE
  WHATSAPP
}

enum CampaignStatus {
  PENDING
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
  FAILED
}

enum CampaignCallStatus {
  PENDING
  QUEUED
  IN_PROGRESS
  COMPLETED
  FAILED
  NO_ANSWER
  BUSY
  VOICEMAIL
  SKIPPED
}

enum CampaignCallOutcome {
  PAYMENT_PROMISED    // Ödeme sözü aldı
  PARTIAL_PAYMENT     // Kısmi ödeme yapacak
  PAYMENT_REFUSED     // Ödeme reddetti
  DISPUTE             // İtiraz var
  CALLBACK_REQUESTED  // Geri arama istedi
  WRONG_NUMBER        // Yanlış numara
  NOT_AVAILABLE       // Müsait değil
  NO_RESPONSE         // Cevap yok
  OTHER               // Diğer
}

model Campaign {
  id              Int             @id @default(autoincrement())
  businessId      Int
  name            String?
  channel         CampaignChannel
  status          CampaignStatus  @default(PENDING)

  // Statistics
  totalCalls      Int             @default(0)
  completedCalls  Int             @default(0)
  successfulCalls Int             @default(0)
  failedCalls     Int             @default(0)

  // Configuration
  maxConcurrent   Int             @default(5)    // Max concurrent calls
  callDelay       Int             @default(5)    // Seconds between calls
  maxRetries      Int             @default(2)    // Max retry attempts per call

  // Script/Prompt for AI
  collectionScript String?        @db.Text       // Custom script for this campaign

  // Timestamps
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  calls           CampaignCall[]

  @@index([businessId])
  @@index([status])
  @@index([createdAt])
}

model CampaignCall {
  id              Int                   @id @default(autoincrement())
  campaignId      Int

  // Customer Info
  customerName    String
  customerPhone   String
  customerEmail   String?

  // Invoice Info (from Paraşüt)
  invoiceId       String?               // Paraşüt invoice ID
  invoiceNumber   String?
  invoiceAmount   Float
  invoiceCurrency String                @default("TRY")
  daysOverdue     Int

  // Call Status
  status          CampaignCallStatus    @default(PENDING)
  outcome         CampaignCallOutcome?
  retryCount      Int                   @default(0)

  // VAPI Integration
  vapiCallId      String?               @unique

  // Call Details
  startedAt       DateTime?
  completedAt     DateTime?
  duration        Int?                  // Duration in seconds

  // Results
  transcript      Json?                 // Call transcript from VAPI
  transcriptText  String?               @db.Text
  summary         String?               @db.Text
  paymentDate     DateTime?             // Promised payment date
  paymentAmount   Float?                // Promised payment amount
  notes           String?               @db.Text

  // Timestamps
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // Relations
  campaign        Campaign              @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([status])
  @@index([customerPhone])
  @@index([vapiCallId])
}

// ============================================================================
// INVITE CODE & WAITLIST TABLES
// ============================================================================

model InviteCode {
  id          String    @id @default(cuid())
  code        String    @unique
  email       String?   // Optional: for specific email
  used        Boolean   @default(false)
  usedBy      String?   // User ID who used
  usedAt      DateTime?
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  createdById String?   // Who created this code

  @@index([code])
  @@index([used])
}

model WaitlistEntry {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  company      String?
  businessType String?
  message      String?
  status       String   @default("pending") // pending, approved, rejected
  createdAt    DateTime @default(now())

  @@index([email])
  @@index([status])
}

// ============================================================================
// KREDİ SİSTEMİ - YENİ MODELLER
// ============================================================================

model CreditPurchase {
  id            String   @id @default(cuid())
  businessId    Int
  minutes       Int                          // Satın alınan dakika miktarı
  amount        Float                        // Ödenen tutar (TL)
  unitPrice     Float                        // Birim fiyat (TL/dk)
  paymentId     String?                      // iyzico payment ID
  status        String   @default("PENDING") // PENDING, COMPLETED, FAILED
  createdAt     DateTime @default(now())

  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([status])
  @@index([createdAt])
}

model UsageLog {
  id            String   @id @default(cuid())
  businessId    Int
  type          String                       // CALL, WHATSAPP, CHAT, EMAIL
  minutes       Float                        // Dakika (çağrı için) veya 0 (diğerleri)
  source        String                       // PACKAGE, CREDIT, OVERAGE
  vapiCallId    String?                      // VAPI call ID (eğer çağrıysa)
  metadata      Json?                        // Ek bilgiler (fromPackage, fromCredit, fromOverage)
  createdAt     DateTime @default(now())

  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// CRM WEBHOOK INTEGRATION TABLES
// ============================================================================

// CRM Webhook Config
model CrmWebhook {
  id            String   @id @default(cuid())
  businessId    Int      @unique
  webhookSecret String   @unique @default(cuid())
  isActive      Boolean  @default(true)
  lastDataAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

// CRM Sipariş Verileri
model CrmOrder {
  id                String    @id @default(cuid())
  businessId        Int
  orderNumber       String
  customerPhone     String
  customerName      String?
  status            String
  trackingNumber    String?
  carrier           String?
  items             Json?
  totalAmount       Float?
  estimatedDelivery DateTime?
  externalUpdatedAt DateTime
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  business          Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, orderNumber])
  @@index([businessId, customerPhone])
}

// CRM Stok Verileri
model CrmStock {
  id                String    @id @default(cuid())
  businessId        Int
  sku               String
  productName       String
  inStock           Boolean
  quantity          Int?
  price             Float?
  estimatedRestock  DateTime?
  externalUpdatedAt DateTime
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  business          Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, sku])
  @@index([businessId, productName])
}

// CRM Servis/Arıza Verileri
model CrmTicket {
  id                  String    @id @default(cuid())
  businessId          Int
  ticketNumber        String
  customerPhone       String
  customerName        String?
  product             String
  issue               String?
  status              String
  notes               String?
  estimatedCompletion DateTime?
  cost                Float?
  externalUpdatedAt   DateTime
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  business            Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, ticketNumber])
  @@index([businessId, customerPhone])
}

// ============================================================================
// BATCH CALL (Excel/CSV Upload Based)
// ============================================================================

enum BatchCallStatus {
  PENDING       // Waiting to start
  IN_PROGRESS   // Currently running
  COMPLETED     // All calls completed
  FAILED        // Failed to process
  CANCELLED     // Cancelled by user
}

model BatchCall {
  id                  String          @id @default(cuid())
  businessId          Int
  assistantId         String
  phoneNumberId       String?         // Phone number used for outbound calls
  name                String          // Campaign name
  elevenLabsBatchId   String?         // 11Labs Batch Call ID
  status              BatchCallStatus @default(PENDING)
  totalRecipients     Int             @default(0)
  completedCalls      Int             @default(0)
  successfulCalls     Int             @default(0)
  failedCalls         Int             @default(0)
  recipients          String          @db.Text    // JSON array of recipients
  columnMapping       String?         @db.Text    // JSON column mapping config
  scheduledAt         DateTime?       // If scheduled for later
  startedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  business            Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  assistant           Assistant       @relation(fields: [assistantId], references: [id], onDelete: Cascade)
  phoneNumber         PhoneNumber?    @relation(fields: [phoneNumberId], references: [id])

  @@index([businessId])
  @@index([status])
  @@index([assistantId])
  @@index([createdAt])
}
