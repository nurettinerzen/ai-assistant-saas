generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  password   String
  role       UserRole @default(MEMBER)
  businessId Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([email])
}

model Business {
  id                      Int                     @id @default(autoincrement())
  name                    String
  language                String                  @default("EN")
  phoneNumbers            String[]                @default([])
  vapiPhoneNumber         String?
  vapiAssistantId         String?
  vapiPitch               Float?                  @default(1.0)
  vapiSpeed               Float?                  @default(1.0)
  vapiTone                VoiceTone?              @default(PROFESSIONAL)
  vapiVoiceGender         VoiceGender?            @default(MALE)
  vapiVoiceId             String?                 @default("male-1-professional")
  businessType            BusinessType            @default(OTHER)
  customGreeting          String?
  customInstructions      String?
  bookingDuration         Int?                    @default(30)
  bufferTime              Int?                    @default(15)
  googleSheetId           String?
  googleSheetLastSync     DateTime?
  googleSheetName         String?
  whatsappPhoneNumberId   String?
  whatsappAccessToken     String?
  whatsappVerifyToken     String?
  whatsappWebhookUrl      String?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  ownerPhone              String?
  ownerWhatsApp           String?
  aiTrainings             AiTraining[]
  appointments            Appointment[]
  assistants              Assistant[]
  bookingIntegration      BookingIntegration?
  businessHours           BusinessHours?
  callLogs                CallLog[]
  erpIntegration          ErpIntegration?
  integrations            Integration[]
  knowledgeBase           KnowledgeBase[]
  provisionedPhoneNumbers PhoneNumber[]           @relation("BusinessPhoneNumbers")
  products                Product[]
  reservationIntegration  ReservationIntegration?
  shippingInfos           ShippingInfo[]
  subscription            Subscription?
  users                   User[]
  emailIntegration        EmailIntegration?
  emailThreads            EmailThread[]
  emailDrafts             EmailDraft[]
  webhookConfig           WebhookConfig?

  @@index([name])
}

model Assistant {
  id              String        @id @default(cuid())
  businessId      Int
  name            String
  voiceId         String
  systemPrompt    String
  model           String        @default("gpt-4")
  vapiAssistantId String?       @unique
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  business        Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  phoneNumbers    PhoneNumber[]

  @@index([businessId])
  @@index([isActive])
}

model PhoneNumber {
  id              String        @id @default(cuid())
  businessId      Int
  phoneNumber     String        @unique
  countryCode     String
  provider        PhoneProvider
  vapiPhoneId     String?       @unique
  netgsmNumberId  String?
  sipUsername     String?
  sipPassword     String?
  sipServer       String?
  assistantId     String?
  status          PhoneStatus   @default(ACTIVE)
  monthlyCost     Float
  nextBillingDate DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  assistant       Assistant?    @relation(fields: [assistantId], references: [id])
  business        Business      @relation("BusinessPhoneNumbers", fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([phoneNumber])
  @@index([status])
}

model Subscription {
  id                   Int                @id @default(autoincrement())
  businessId           Int                @unique
  plan                 SubscriptionPlan   @default(FREE)
  status               SubscriptionStatus @default(TRIAL)
  stripeCustomerId     String?
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  minutesUsed          Int                @default(0)
  callsThisMonth       Int                @default(0)
  assistantsCreated    Int                @default(0)
  phoneNumbersUsed     Int                @default(0)
  minutesLimit         Int                @default(0)
  callsLimit           Int                @default(0)
  assistantsLimit      Int                @default(0)
  phoneNumbersLimit    Int                @default(0)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  business             Business           @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([plan])
  @@index([status])
}

model CallLog {
  id                Int      @id @default(autoincrement())
  businessId        Int
  callId            String   @unique
  callerId          String?
  duration          Int?
  status            String
  transcript        Json?    // Array of {speaker, text, timestamp}
  transcriptText    String?  @db.Text // Plain text for search
  recordingUrl      String?  @db.Text
  recordingDuration Int?     // Duration in seconds
  intent            String?
  sentiment         String?  // 'positive', 'neutral', 'negative'
  sentimentScore    Float?   // 0.0 to 1.0
  summary           String?  @db.Text
  keyPoints         String[] @default([])
  keyTopics         String[] @default([]) // ['appointment', 'pricing', 'availability']
  actionItems       String[] @default([]) // ['Schedule follow-up', 'Send email']
  taskCompleted     Boolean?
  followUpNeeded    Boolean?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  business          Business @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([callId])
  @@index([createdAt])
  @@index([status])
}

model Integration {
  id          Int                   @id @default(autoincrement())
  businessId  Int
  type        IntegrationType
  credentials Json
  isActive    Boolean               @default(true)
  syncEnabled Boolean               @default(true)
  lastSync    DateTime?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  connected   Boolean?              @default(false)
  relevantFor BusinessType[]        @default([])
  priority    IntegrationPriority?  @default(OPTIONAL)
  business    Business              @relation(fields: [businessId], references: [id])

  @@unique([businessId, type])
  @@index([businessId])
  @@index([type])
}

model BusinessHours {
  id         Int      @id @default(autoincrement())
  businessId Int      @unique
  monday     Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  tuesday    Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  wednesday  Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  thursday   Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  friday     Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  saturday   Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": true}")
  sunday     Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": true}")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id])
}

model Appointment {
  id              Int               @id @default(autoincrement())
  businessId      Int
  customerName    String
  customerPhone   String
  customerEmail   String?
  appointmentDate DateTime
  duration        Int
  serviceType     String?
  notes           String?
  status          AppointmentStatus @default(PENDING)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  business        Business          @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([appointmentDate])
  @@index([status])
}

model Product {
  id                Int            @id @default(autoincrement())
  businessId        Int
  sku               String
  name              String
  description       String?
  price             Float
  category          String?
  imageUrl          String?
  stockQuantity     Int            @default(0)
  lowStockThreshold Int            @default(10)
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  inventoryLogs     InventoryLog[]
  business          Business       @relation(fields: [businessId], references: [id])

  @@unique([businessId, sku])
  @@index([businessId])
  @@index([category])
  @@index([isActive])
}

model InventoryLog {
  id             Int                 @id @default(autoincrement())
  productId      Int
  changeType     InventoryChangeType
  quantityChange Int
  newQuantity    Int
  note           String?
  createdAt      DateTime            @default(now())
  product        Product             @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([createdAt])
}

model ShippingInfo {
  id                Int             @id @default(autoincrement())
  businessId        Int
  orderId           String
  trackingNumber    String
  carrier           ShippingCarrier
  status            ShippingStatus  @default(PENDING)
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  customerPhone     String?
  customerEmail     String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  business          Business        @relation(fields: [businessId], references: [id])

  @@unique([businessId, orderId])
  @@index([businessId])
  @@index([trackingNumber])
  @@index([status])
}

model AiTraining {
  id           Int      @id @default(autoincrement())
  businessId   Int
  title        String
  instructions String
  category     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([isActive])
}

model KnowledgeBase {
  id          String          @id @default(cuid())
  businessId  Int
  type        KnowledgeType
  title       String
  content     String?
  fileName    String?
  fileSize    Int?
  mimeType    String?
  filePath    String?
  url         String?
  crawlDepth  Int?
  pageCount   Int?
  lastCrawled DateTime?
  question    String?
  answer      String?
  category    String?
  status      KnowledgeStatus @default(PROCESSING)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  business    Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([type])
  @@index([status])
}

model ErpIntegration {
  id           Int       @id @default(autoincrement())
  businessId   Int       @unique
  type         ErpType
  apiEndpoint  String?
  apiKey       String?
  username     String?
  password     String?
  companyCode  String?
  syncEnabled  Boolean   @default(true)
  syncInterval Int       @default(60)
  lastSync     DateTime?
  realtimeMode Boolean   @default(false)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  business     Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model ReservationIntegration {
  id            Int                 @id @default(autoincrement())
  businessId    Int                 @unique
  platform      ReservationPlatform
  apiKey        String?
  apiSecret     String?
  restaurantId  String?
  syncEnabled   Boolean             @default(true)
  autoSync      Boolean             @default(true)
  lastSync      DateTime?
  webhookUrl    String?
  webhookSecret String?
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  business      Business            @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model BookingIntegration {
  id            Int             @id @default(autoincrement())
  businessId    Int             @unique
  platform      BookingPlatform
  apiKey        String?
  shopId        String?
  accessToken   String?
  syncEnabled   Boolean         @default(true)
  bidirectional Boolean         @default(false)
  lastSync      DateTime?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  business      Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

enum UserRole {
  OWNER
  ADMIN
  MEMBER
}

enum BusinessType {
  RESTAURANT
  SALON
  ECOMMERCE
  CLINIC
  SERVICE
  OTHER
}

enum VoiceGender {
  MALE
  FEMALE
}

enum VoiceTone {
  PROFESSIONAL
  FRIENDLY
  WARM
  ENERGETIC
}

enum PhoneProvider {
  VAPI
  NETGSM
  TWILIO
  CUSTOM
}

enum PhoneStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum SubscriptionPlan {
  FREE
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
}

enum IntegrationType {
  OPENTABLE
  CALENDLY
  SHOPIFY
  STRIPE_PAYMENTS
  TWILIO_SMS
  SENDGRID_EMAIL
  GOOGLE_CALENDAR
  HUBSPOT
  ZAPIER
  WHATSAPP
  GOOGLE_SHEETS
  SLACK
  SALESFORCE
  WOOCOMMERCE
  TOAST_POS
  SQUARE
  SIMPLEPRACTICE
  ZOCDOC
  BOOKSY
  FRESHA
  SHIPSTATION
  KLAVIYO
  MAILCHIMP
  YURTICI_KARGO
  ARAS_KARGO
  MNG_KARGO
  TRENDYOL
  PARASUT
  IYZICO
  CUSTOM
}

enum IntegrationPriority {
  ESSENTIAL
  RECOMMENDED
  OPTIONAL
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum InventoryChangeType {
  SALE
  RESTOCK
  ADJUSTMENT
  RETURN
}

enum ShippingCarrier {
  UPS
  FEDEX
  USPS
  DHL
  YURTICI
  ARAS
  MNG
  PTT
  SURAT
  OTHER
}

enum ShippingStatus {
  PENDING
  SHIPPED
  IN_TRANSIT
  DELIVERED
  RETURNED
}

enum KnowledgeType {
  DOCUMENT
  FAQ
  URL
}

enum KnowledgeStatus {
  PROCESSING
  ACTIVE
  FAILED
}

enum ErpType {
  MIKRO
  SAP
  NETSUITE
  ODOO
  CUSTOM
}

enum ReservationPlatform {
  YELP
  OPENTABLE
  RESY
  GOOGLE_RESERVE
  CUSTOM
}

enum BookingPlatform {
  BOOKSY
  SQUARE_APPOINTMENTS
  FRESHA
  VAGARO
  SCHEDULICITY
  CUSTOM
}

// ==================== EMAIL CHANNEL MODELS ====================

enum EmailProvider {
  GMAIL
  OUTLOOK
}

enum EmailThreadStatus {
  PENDING_REPLY
  DRAFT_READY
  REPLIED
  CLOSED
}

enum EmailMessageDirection {
  INBOUND
  OUTBOUND
}

enum EmailMessageStatus {
  RECEIVED
  DRAFT
  APPROVED
  SENT
}

enum EmailDraftStatus {
  PENDING_REVIEW
  APPROVED
  SENT
  REJECTED
}

model EmailIntegration {
  id            Int           @id @default(autoincrement())
  businessId    Int           @unique
  provider      EmailProvider
  email         String        // Connected email address
  credentials   Json          // access_token, refresh_token, expiry
  connected     Boolean       @default(true)
  lastSyncedAt  DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  business      Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([provider])
}

model EmailThread {
  id            String            @id @default(cuid())
  businessId    Int
  threadId      String            // Gmail/Outlook thread ID
  subject       String
  customerEmail String
  customerName  String?
  status        EmailThreadStatus @default(PENDING_REPLY)
  lastMessageAt DateTime
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  business      Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  messages      EmailMessage[]
  drafts        EmailDraft[]

  @@unique([businessId, threadId])
  @@index([businessId])
  @@index([status])
  @@index([lastMessageAt])
}

model EmailMessage {
  id           String                @id @default(cuid())
  threadId     String
  messageId    String                // Gmail/Outlook message ID
  direction    EmailMessageDirection
  fromEmail    String
  fromName     String?
  toEmail      String
  subject      String
  bodyText     String?               @db.Text
  bodyHtml     String?               @db.Text
  attachments  Json?                 // [{name, size, mimeType}]
  isDraft      Boolean               @default(false)
  status       EmailMessageStatus    @default(RECEIVED)
  sentAt       DateTime?
  receivedAt   DateTime?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  thread       EmailThread           @relation(fields: [threadId], references: [id], onDelete: Cascade)
  drafts       EmailDraft[]

  @@unique([threadId, messageId])
  @@index([threadId])
  @@index([direction])
  @@index([status])
}

model EmailDraft {
  id               String           @id @default(cuid())
  messageId        String?          // Which message this is replying to
  threadId         String
  businessId       Int
  generatedContent String           @db.Text  // AI-generated draft
  editedContent    String?          @db.Text  // User's edited version
  status           EmailDraftStatus @default(PENDING_REVIEW)
  reviewedAt       DateTime?
  reviewedBy       Int?             // User ID who reviewed
  sentAt           DateTime?
  sentMessageId    String?          // ID of sent message
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  thread           EmailThread      @relation(fields: [threadId], references: [id], onDelete: Cascade)
  message          EmailMessage?    @relation(fields: [messageId], references: [id])
  business         Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([businessId])
  @@index([status])
}

// ============================================================================
// WEBHOOK INTEGRATION TABLES
// ============================================================================

model WebhookConfig {
  id            Int       @id @default(autoincrement())
  businessId    Int       @unique
  webhookSecret String    @unique @default(cuid())
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([webhookSecret])
}

model WebhookLog {
  id          Int       @id @default(autoincrement())
  businessId  Int
  type        String    // order, inventory, shipment, custom
  action      String?   // created, updated, deleted
  payload     Json
  status      String    @default("received") // received, processed, failed
  errorMessage String?
  processedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([businessId])
  @@index([type])
  @@index([createdAt])
}

model WebhookOrder {
  id              Int       @id @default(autoincrement())
  businessId      Int
  externalId      String
  customerName    String?
  customerPhone   String?
  customerEmail   String?
  status          String    @default("pending")
  statusText      String?
  totalAmount     Float?
  currency        String    @default("TRY")
  items           Json?
  trackingNumber  String?
  trackingCarrier String?
  trackingUrl     String?
  source          String    @default("webhook") // zapier, make, custom
  rawPayload      Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([businessId, externalId])
  @@index([businessId])
  @@index([customerPhone])
  @@index([customerEmail])
  @@index([externalId])
}

model WebhookInventory {
  id          Int       @id @default(autoincrement())
  businessId  Int
  externalId  String?
  productName String
  sku         String?
  stock       Int       @default(0)
  source      String    @default("webhook")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([businessId, sku])
  @@index([businessId])
  @@index([sku])
}
