generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  Int                      @id @default(autoincrement())
  email               String                   @unique
  password            String
  name                String?
  role                UserRole                 @default(STAFF)
  businessId          Int
  invitedById         Int?
  invitedAt           DateTime?
  acceptedAt          DateTime?
  onboardingCompleted Boolean                  @default(false)
  emailVerified       Boolean                  @default(false)
  emailVerifiedAt     DateTime?
  // Suspension fields (Admin Panel)
  suspended           Boolean                  @default(false)
  suspendedAt         DateTime?
  suspendReason       String?
  deletedAt           DateTime?
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  business            Business                 @relation(fields: [businessId], references: [id])
  invitedBy           User?                    @relation("UserInvitations", fields: [invitedById], references: [id])
  invitedUsers        User[]                   @relation("UserInvitations")
  sentInvitations     Invitation[]             @relation("InvitedByUser")
  verificationTokens  EmailVerificationToken[]
  passwordResetTokens PasswordResetToken[]
  auditLogsAsActor    BusinessAuditLog[]       @relation("AuditActor")
  auditLogsAsTarget   BusinessAuditLog[]       @relation("AuditTarget")

  @@index([businessId])
  @@index([email])
  @@index([suspended])
}

model Invitation {
  id          Int       @id @default(autoincrement())
  email       String
  businessId  Int
  role        UserRole
  token       String?   @unique // Nullable for replay prevention (set to null after accept)
  invitedById Int
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime  @default(now())
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invitedBy   User      @relation("InvitedByUser", fields: [invitedById], references: [id])

  @@index([businessId])
  @@index([token])
  @@index([email])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Business {
  id                       Int                     @id @default(autoincrement())
  name                     String
  chatEmbedKey             String?                 @unique // Unique key for chat widget embedding
  chatWidgetEnabled        Boolean                 @default(false) // Is chat widget active for this business
  chatAssistantId          String?                 // Preferred assistant for chat-capable channels (chat/wa/email)
  phoneInboundEnabled      Boolean                 @default(false) // Admin toggle: false=V1 outbound-only, true=FULL V2 inbound
  onboardingCompletedAt    DateTime?               // Business-level onboarding completion timestamp
  language                 String                  @default("TR") // Uygulama dili (TR, EN, PR, DE, ES, FR...)
  country                  String                  @default("TR") // Bölge kodu (TR, BR, US, DE...)
  currency                 String                  @default("TRY") // Para birimi (TRY, BRL, USD, EUR...)
  timezone                 String                  @default("Europe/Istanbul")
  phoneNumbers             String[]                @default([])
  businessType             BusinessType            @default(OTHER)
  customGreeting           String?
  customInstructions       String?
  bookingDuration          Int?                    @default(30)
  bufferTime               Int?                    @default(15)
  googleSheetId            String?
  googleSheetLastSync      DateTime?
  googleSheetName          String?
  // Google Sheets OAuth fields
  googleSheetsAccessToken  String?                 @db.Text
  googleSheetsRefreshToken String?                 @db.Text
  googleSheetsTokenExpiry  DateTime?
  googleSheetsConnected    Boolean                 @default(false)
  whatsappPhoneNumberId    String?
  whatsappAccessToken      String?
  whatsappVerifyToken      String?
  whatsappWebhookUrl       String?
  // Suspension fields (Admin Panel)
  suspended                Boolean                 @default(false)
  suspendedAt              DateTime?
  suspendReason            String?
  deletedAt                DateTime?
  createdAt                DateTime                @default(now())
  updatedAt                DateTime                @updatedAt
  ownerPhone               String?
  ownerWhatsApp            String?
  // Email RAG Settings
  emailRagEnabled          Boolean                 @default(true)
  emailSnippetsEnabled     Boolean                 @default(true)
  emailRagMaxExamples      Int                     @default(3)
  emailRagMaxSnippets      Int                     @default(2)
  emailRagMinConfidence    Float                   @default(0.7) // Min classification confidence for RAG (0.0-1.0)
  crmVersion               Int                     @default(0) // Cache invalidation for CRM data changes (P0.3b)
  // KB_ONLY Channel Mode config
  channelConfig            Json?                   // {"chat":"KB_ONLY","whatsapp":"KB_ONLY","email":"FULL","phone":"FULL"}
  helpLinks                Json?                   // {"order_status_url":"...","returns_url":"...","account_url":"...","contact_url":"...","support_email":"..."}
  aiTrainings              AiTraining[]
  appointments             Appointment[]
  assistants               Assistant[]
  bookingIntegration       BookingIntegration?
  businessHours            BusinessHours?
  callLogs                 CallLog[]
  activeCallSessions       ActiveCallSession[]
  erpIntegration           ErpIntegration?
  integrations             Integration[]
  knowledgeBase            KnowledgeBase[]
  provisionedPhoneNumbers  PhoneNumber[]           @relation("BusinessPhoneNumbers")
  products                 Product[]
  reservationIntegration   ReservationIntegration?
  shippingInfos            ShippingInfo[]
  subscription             Subscription?
  users                    User[]
  emailIntegration         EmailIntegration?
  emailThreads             EmailThread[]
  emailDrafts              EmailDraft[]
  emailEmbeddings          EmailEmbedding[]
  emailSnippets            EmailSnippet[]
  webhookConfig            WebhookConfig?
  invitations              Invitation[]
  creditPurchases          CreditPurchase[]
  usageLogs                UsageLog[]
  crmWebhook               CrmWebhook?
  crmWebhookEvents         CrmWebhookEvent[] @relation("CrmWebhookEvents")
  crmOrders                CrmOrder[]
  crmStocks                CrmStock[]
  crmTickets               CrmTicket[]
  auditLogs                BusinessAuditLog[]
  batchCalls               BatchCall[]
  customerData             CustomerData[]
  customerDataFiles        CustomerDataFile[]
  callbackRequests         CallbackRequest[]
  doNotCalls              DoNotCall[]
  chatLogs                 ChatLog[]
  pilotBusinesses          PilotBusiness[]         @relation("PilotBusinesses")
  emailPairs               EmailPair[]             @relation("EmailPairs")
  oauthStates              OAuthState[]            @relation("OAuthStates")

  @@index([name])
  @@index([suspended])
  @@index([chatAssistantId])
}

model Assistant {
  id                String            @id @default(cuid())
  businessId        Int
  name              String
  assistantType     String            @default("phone") // "text" | "phone"
  voiceId           String? // null for text assistants
  systemPrompt      String            @db.Text
  model             String            @default("gpt-4")
  elevenLabsAgentId String?           @unique // 11Labs Conversational AI Agent ID
  isActive          Boolean           @default(true)
  timezone          String? // Business timezone for date/time context
  firstMessage      String? // Custom first message
  tone              String            @default("professional") // "friendly" or "professional"
  customNotes       String?           @db.Text // Business-specific notes
  callDirection     String            @default("outbound") // phone-only: "inbound" | "outbound" | "outbound_*"
  channelCapabilities String[]        @default(["phone_outbound"]) // ["chat","whatsapp","email","phone_outbound","phone_inbound"]
  callPurpose       String? // For outbound: "collection", "reminder", "survey", "info", "custom"
  dynamicVariables  String[]          @default([]) // Dynamic variable names for outbound calls
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  phoneNumbers      PhoneNumber[]
  batchCalls        BatchCall[]
  callbackRequests  CallbackRequest[]
  chatLogs          ChatLog[]

  @@index([businessId])
  @@index([isActive])
  @@index([callDirection])
}

model PhoneNumber {
  id                String        @id @default(cuid())
  businessId        Int
  phoneNumber       String        @unique
  countryCode       String
  provider          PhoneProvider
  elevenLabsPhoneId String?       @unique // 11Labs phone number ID
  netgsmNumberId    String?
  sipUsername       String?
  sipPassword       String?
  sipServer         String?
  assistantId       String?
  status            PhoneStatus   @default(ACTIVE)
  monthlyCost       Float
  nextBillingDate   DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  assistant         Assistant?    @relation(fields: [assistantId], references: [id])
  business          Business      @relation("BusinessPhoneNumbers", fields: [businessId], references: [id], onDelete: Cascade)
  batchCalls        BatchCall[]

  @@index([businessId])
  @@index([phoneNumber])
  @@index([status])
}

model Subscription {
  id                       Int                @id @default(autoincrement())
  businessId               Int                @unique
  plan                     SubscriptionPlan   @default(FREE)
  status                   SubscriptionStatus @default(TRIAL)
  paymentProvider          String?            @default("stripe") // "stripe" or "iyzico"
  // Stripe fields
  stripeCustomerId         String?
  stripeSubscriptionId     String?            @unique
  stripePriceId            String?
  // iyzico fields
  iyzicoCustomerId         String?
  iyzicoSubscriptionId     String?            @unique
  iyzicoReferenceCode      String?            @unique
  iyzicoPricingPlanId      String?
  iyzicoCardToken          String?
  iyzicoPaymentId          String? // For checkout form payments
  // Pending subscription fields (for callback)
  pendingSubscriptionToken String?
  pendingPlanId            String?
  // Common fields
  currentPeriodStart       DateTime?
  currentPeriodEnd         DateTime?
  cancelAtPeriodEnd        Boolean            @default(false)
  minutesUsed              Int                @default(0)
  callsThisMonth           Int                @default(0)
  assistantsCreated        Int                @default(0)
  phoneNumbersUsed         Int                @default(0)
  minutesLimit             Int                @default(0)
  callsLimit               Int                @default(0)
  assistantsLimit          Int                @default(0)
  phoneNumbersLimit        Int                @default(0)

  // ============================================================================
  // YENİ FİYATLANDIRMA SİSTEMİ - Bakiye bazlı
  // ============================================================================

  // TL cinsinden bakiye (PAYG ve aşım için)
  balance Float @default(0) // TL cinsinden bakiye

  // Deneme sistemi
  trialMinutesUsed Float     @default(0) // Deneme dakikası kullanımı (15 dk limit)
  trialChatExpiry  DateTime? // Chat/WhatsApp deneme bitiş tarihi (7 gün)
  trialStartDate   DateTime? // Deneme başlangıç tarihi

  // Dahil dakika sistemi (STARTER/PRO için)
  includedMinutesUsed    Float     @default(0) // Bu ay kullanılan dahil dakika
  includedMinutesResetAt DateTime? // Dahil dakika sıfırlama tarihi

  // Otomatik bakiye yükleme
  autoReloadEnabled   Boolean @default(false) // Otomatik yükleme açık/kapalı
  autoReloadThreshold Float   @default(2) // Kaç dakika kaldığında yükle
  autoReloadAmount    Float   @default(5) // Kaç dakika yükle

  // Kredi sistemi (YENİ) - Legacy, bakiye sistemi ile değiştirildi
  creditMinutes     Int @default(0) // Satın alınan toplam kredi dakikaları
  creditMinutesUsed Int @default(0) // Krediden kullanılan dakikalar

  // Aşım sistemi (YENİ) - POSTPAID model için
  overageMinutes  Int       @default(0) // Bu ay aşım dakikaları
  overageRate     Float     @default(23) // SABİT 23 TL/dk aşım ücreti
  overageLimit    Int       @default(200) // Max aşım limiti (dakika)
  overageBilledAt DateTime? // Son aşım faturalama tarihi

  // Uyarı durumları (YENİ)
  packageWarningAt80  Boolean   @default(false) // Paket %80 uyarısı gönderildi mi
  creditWarningAt80   Boolean   @default(false) // Kredi %80 uyarısı gönderildi mi
  overageLimitReached Boolean   @default(false) // Aşım limiti aşıldı mı
  lowBalanceWarningAt DateTime? // Son düşük bakiye uyarısı gönderilme tarihi

  // Concurrent call limitleri (YENİ)
  concurrentLimit Int @default(1) // Max eşzamanlı çağrı limiti
  activeCalls     Int @default(0) // Şu anki aktif çağrı sayısı

  // ============================================================================
  // CHAT/WHATSAPP KULLANIM TAKIBI (Anti-abuse)
  // ============================================================================
  chatTokensUsed       Int       @default(0) // Bu dönem kullanılan toplam token
  chatTokensResetAt    DateTime? // Token sayacı sıfırlama tarihi
  chatTokensLimit      Int       @default(0) // Aylık token limiti (0 = sınırsız ama ücretli)
  chatDailyMessageDate DateTime? // Son mesaj tarih (rate limit için)
  chatDailyMessageCount Int      @default(0) // Bugün gönderilen mesaj sayısı

  // ============================================================================
  // KURUMSAL PLAN ALANLARI
  // ============================================================================
  enterpriseMinutes       Int? // Özel dakika limiti
  enterprisePrice         Float? // Özel aylık fiyat (TL)
  enterpriseConcurrent    Int? // Özel eş zamanlı çağrı limiti
  enterpriseAssistants    Int? // Özel asistan limiti (null = sınırsız)
  enterpriseStartDate     DateTime? // Kurumsal plan başlangıç
  enterpriseEndDate       DateTime? // Kurumsal plan bitiş
  enterprisePaymentStatus String? // 'pending', 'paid', 'overdue'
  enterpriseNotes         String?   @db.Text // Admin notları

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  business  Business @relation(fields: [businessId], references: [id])

  // İlişkiler
  usageRecords        UsageRecord[]
  balanceTransactions BalanceTransaction[]

  @@index([businessId])
  @@index([plan])
  @@index([status])
  @@index([paymentProvider])
}

model ChatLog {
  id            String  @id @default(cuid())
  businessId    Int
  sessionId     String  @unique // Unique session identifier
  assistantId   String?
  channel       String  @default("CHAT") // CHAT, WHATSAPP
  customerIp    String? // For analytics (web chat)
  customerPhone String? // For WhatsApp
  messageCount  Int     @default(0)
  messages      Json? // Array of {role, content, timestamp}
  summary       String? @db.Text
  status        String  @default("active") // active, completed

  // Token kullanımı ve maliyet bilgileri
  inputTokens  Int   @default(0) // Toplam input token sayısı
  outputTokens Int   @default(0) // Toplam output token sayısı
  totalCost    Float @default(0) // Toplam maliyet TL cinsinden

  // Normalleştirilmiş konu kategorileri (AI tarafından belirlenir)
  normalizedCategory String? // Sipariş, İade, Ödeme, Muhasebe, Ürün, Teslimat, Destek, Randevu, Genel
  normalizedTopic    String? // Kategori içindeki spesifik konu (örn: "Sipariş Durumu Sorgulama")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business  Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  assistant Assistant? @relation(fields: [assistantId], references: [id], onDelete: SetNull)

  @@index([businessId])
  @@index([createdAt])
  @@index([status])
  @@index([channel])
  @@index([normalizedCategory])
}

model CallLog {
  id                Int      @id @default(autoincrement())
  businessId        Int
  callId            String   @unique
  callerId          String?
  duration          Int?
  status            String // Mevcut teknik durum alanı (completed, in-progress vb.)
  direction         String? // "inbound" or "outbound" - arama yönü
  transcript        Json? // Array of {speaker, text, timestamp}
  transcriptText    String?  @db.Text // Plain text for search
  recordingUrl      String?  @db.Text
  recordingDuration Int? // Duration in seconds
  intent            String?
  sentiment         String? // DEPRECATED: Eski içerik analizi
  sentimentScore    Float? // DEPRECATED: 0.0 to 1.0
  summary           String?  @db.Text
  keyPoints         String[] @default([])
  keyTopics         String[] @default([]) // ['appointment', 'pricing', 'availability']
  actionItems       String[] @default([]) // ['Schedule follow-up', 'Send email']
  taskCompleted     Boolean?
  followUpNeeded    Boolean?

  // === YENİ DURUM ANALİZİ ALANLARI ===
  // Sonuç: Arama teknik olarak başarılı mı?
  callResult CallResult?

  // Durum: İçerik olarak başarılı mı? (müşteri sorularının cevaplanma oranı)
  callStatus CallStatus?

  // Analiz detayları
  analysisData Json? // { totalRequests, answeredRequests, callbackCreated, unansweredCategories, summary }

  // Voicemail detection
  voicemailDetected Boolean? @default(false)

  // Arama sonlanma bilgisi
  endReason String? // client_ended, agent_ended, system_timeout, error vb.

  // Maliyet bilgisi (TL cinsinden)
  callCost Float? @default(0)

  // Normalleştirilmiş konu kategorileri (AI tarafından belirlenir)
  normalizedCategory String? // Sipariş, İade, Ödeme, Muhasebe, Ürün, Teslimat, Destek, Randevu, Genel
  normalizedTopic    String? // Kategori içindeki spesifik konu (örn: "Sipariş Durumu Sorgulama")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  business  Business @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([callId])
  @@index([createdAt])
  @@index([status])
  @@index([direction])
  @@index([callResult])
  @@index([callStatus])
  @@index([normalizedCategory])
}

// P0.3: Active call session tracking for concurrent call management
// Real-time tracking of active calls for reconciliation and cleanup
model ActiveCallSession {
  id         Int      @id @default(autoincrement())
  callId     String   @unique // 11Labs conversation ID or VAPI call ID
  businessId Int
  plan       String // PAYG, STARTER, PRO, ENTERPRISE
  direction  String // "inbound" or "outbound"
  status     String   @default("active") // active, ended, failed
  provider   String   @default("elevenlabs") // elevenlabs, vapi

  // Timing
  startedAt  DateTime @default(now())
  endedAt    DateTime?

  // Metadata for debugging
  metadata   Json?    // { assistantId, phoneNumber, etc. }

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id])

  @@index([callId])
  @@index([businessId])
  @@index([status])
  @@index([startedAt])
  @@index([plan])
}

// Arama teknik sonucu
enum CallResult {
  SUCCESS // Arama gerçekleşti
  FAILED // Arama başarısız (hata, bağlantı sorunu)
  NO_ANSWER // Cevap verilmedi
  VOICEMAIL // Sesli mesaja düştü
  BUSY // Meşgul
}

// Arama içerik durumu (müşteri soruları cevaplanma oranı)
enum CallStatus {
  POSITIVE // Müşterinin soruları cevaplandı (%80+)
  NEUTRAL // Kısmen cevaplandı (%50-80) veya insana aktarıldı
  NEGATIVE // Cevap verilemedi (%50-)
}

model Integration {
  id          Int                  @id @default(autoincrement())
  businessId  Int
  type        IntegrationType
  credentials Json
  isActive    Boolean              @default(true)
  syncEnabled Boolean              @default(true)
  lastSync    DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  connected   Boolean?             @default(false)
  relevantFor BusinessType[]       @default([])
  priority    IntegrationPriority? @default(OPTIONAL)
  business    Business             @relation(fields: [businessId], references: [id])

  @@unique([businessId, type])
  @@index([businessId])
  @@index([type])
}

model BusinessHours {
  id         Int      @id @default(autoincrement())
  businessId Int      @unique
  monday     Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  tuesday    Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  wednesday  Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  thursday   Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  friday     Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": false}")
  saturday   Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": true}")
  sunday     Json?    @default("{\"open\": \"09:00\", \"close\": \"17:00\", \"closed\": true}")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id])
}

model Appointment {
  id              Int               @id @default(autoincrement())
  businessId      Int
  customerName    String
  customerPhone   String
  customerEmail   String?
  appointmentDate DateTime
  duration        Int
  serviceType     String?
  notes           String?
  status          AppointmentStatus @default(PENDING)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  business        Business          @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([appointmentDate])
  @@index([status])
}

model Product {
  id                Int            @id @default(autoincrement())
  businessId        Int
  sku               String
  name              String
  description       String?
  price             Float
  category          String?
  imageUrl          String?
  stockQuantity     Int            @default(0)
  lowStockThreshold Int            @default(10)
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  inventoryLogs     InventoryLog[]
  business          Business       @relation(fields: [businessId], references: [id])

  @@unique([businessId, sku])
  @@index([businessId])
  @@index([category])
  @@index([isActive])
}

model InventoryLog {
  id             Int                 @id @default(autoincrement())
  productId      Int
  changeType     InventoryChangeType
  quantityChange Int
  newQuantity    Int
  note           String?
  createdAt      DateTime            @default(now())
  product        Product             @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([createdAt])
}

model ShippingInfo {
  id                Int             @id @default(autoincrement())
  businessId        Int
  orderId           String
  trackingNumber    String
  carrier           ShippingCarrier
  status            ShippingStatus  @default(PENDING)
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  customerPhone     String?
  customerEmail     String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  business          Business        @relation(fields: [businessId], references: [id])

  @@unique([businessId, orderId])
  @@index([businessId])
  @@index([trackingNumber])
  @@index([status])
}

model AiTraining {
  id           Int      @id @default(autoincrement())
  businessId   Int
  title        String
  instructions String
  category     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([isActive])
}

model KnowledgeBase {
  id              String          @id @default(cuid())
  businessId      Int
  type            KnowledgeType
  title           String
  content         String?
  fileName        String?
  fileSize        Int?
  mimeType        String?
  filePath        String?
  url             String?
  crawlDepth      Int?
  pageCount       Int?
  lastCrawled     DateTime?
  autoScan        Boolean         @default(false) // Otomatik tarama aktif mi
  scanInterval    Int?            @default(24) // Tarama aralığı (saat cinsinden)
  question        String?
  answer          String?
  category        String?
  elevenLabsDocId String? // 11Labs knowledge base document ID
  status          KnowledgeStatus @default(PROCESSING)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  business        Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([type])
  @@index([status])
}

model ErpIntegration {
  id           Int       @id @default(autoincrement())
  businessId   Int       @unique
  type         ErpType
  apiEndpoint  String?
  apiKey       String?
  username     String?
  password     String?
  companyCode  String?
  syncEnabled  Boolean   @default(true)
  syncInterval Int       @default(60)
  lastSync     DateTime?
  realtimeMode Boolean   @default(false)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  business     Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model ReservationIntegration {
  id            Int                 @id @default(autoincrement())
  businessId    Int                 @unique
  platform      ReservationPlatform
  apiKey        String?
  apiSecret     String?
  restaurantId  String?
  syncEnabled   Boolean             @default(true)
  autoSync      Boolean             @default(true)
  lastSync      DateTime?
  webhookUrl    String?
  webhookSecret String?
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  business      Business            @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model BookingIntegration {
  id            Int             @id @default(autoincrement())
  businessId    Int             @unique
  platform      BookingPlatform
  apiKey        String?
  shopId        String?
  accessToken   String?
  syncEnabled   Boolean         @default(true)
  bidirectional Boolean         @default(false)
  lastSync      DateTime?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  business      Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

enum UserRole {
  OWNER
  MANAGER
  STAFF
}

enum BusinessType {
  RESTAURANT
  SALON
  ECOMMERCE
  CLINIC
  SERVICE
  OTHER
}

enum VoiceGender {
  MALE
  FEMALE
}

enum VoiceTone {
  PROFESSIONAL
  FRIENDLY
  WARM
  ENERGETIC
}

enum PhoneProvider {
  ELEVENLABS // 11Labs Conversational AI
  NETGSM
  TWILIO
  CUSTOM
}

enum PhoneStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum SubscriptionPlan {
  FREE
  TRIAL // Deneme: 15 dk telefon, 7 gün chat/whatsapp
  PAYG // Kullandıkça Öde: Taahhütsüz, 23 TL/dk
  STARTER // Başlangıç: 2.499 TL/ay, 150 dk dahil
  PRO // Profesyonel: 7.499 TL/ay, 500 dk dahil
  ENTERPRISE // Kurumsal: Özel fiyat
  BASIC // Deprecated: eski paket, geriye dönük uyumluluk için
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
}

enum IntegrationType {
  OPENTABLE
  CALENDLY
  SHOPIFY
  STRIPE_PAYMENTS
  TWILIO_SMS
  SENDGRID_EMAIL
  GOOGLE_CALENDAR
  HUBSPOT
  ZAPIER
  WHATSAPP
  GOOGLE_SHEETS
  SLACK
  SALESFORCE
  WOOCOMMERCE
  TOAST_POS
  SQUARE
  SIMPLEPRACTICE
  ZOCDOC
  BOOKSY
  FRESHA
  SHIPSTATION
  KLAVIYO
  MAILCHIMP
  YURTICI_KARGO
  ARAS_KARGO
  MNG_KARGO
  TRENDYOL
  PARASUT
  IYZICO
  IKAS
  IDEASOFT
  TICIMAX
  CUSTOM
}

enum IntegrationPriority {
  ESSENTIAL
  RECOMMENDED
  OPTIONAL
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum InventoryChangeType {
  SALE
  RESTOCK
  ADJUSTMENT
  RETURN
}

enum ShippingCarrier {
  UPS
  FEDEX
  USPS
  DHL
  YURTICI
  ARAS
  MNG
  PTT
  SURAT
  OTHER
}

enum ShippingStatus {
  PENDING
  SHIPPED
  IN_TRANSIT
  DELIVERED
  RETURNED
}

enum KnowledgeType {
  DOCUMENT
  FAQ
  URL
}

enum KnowledgeStatus {
  PROCESSING
  ACTIVE
  FAILED
}

enum ErpType {
  MIKRO
  SAP
  NETSUITE
  ODOO
  CUSTOM
}

enum ReservationPlatform {
  YELP
  OPENTABLE
  RESY
  GOOGLE_RESERVE
  CUSTOM
}

enum BookingPlatform {
  BOOKSY
  SQUARE_APPOINTMENTS
  FRESHA
  VAGARO
  SCHEDULICITY
  CUSTOM
}

// ==================== EMAIL CHANNEL MODELS ====================

enum EmailProvider {
  GMAIL
  OUTLOOK
}

enum EmailThreadStatus {
  NEW // New email, no action taken yet
  PENDING_REPLY // Legacy - kept for backward compatibility
  DRAFT_READY // AI draft generated, waiting for review
  REPLIED // Email has been replied to
  CLOSED // Thread closed manually
  NO_REPLY_NEEDED // User marked as no reply needed
}

enum EmailMessageDirection {
  INBOUND
  OUTBOUND
}

enum EmailMessageStatus {
  RECEIVED
  DRAFT
  APPROVED
  SENT
}

enum EmailDraftStatus {
  PENDING_REVIEW
  APPROVED
  SENT
  REJECTED
  CANCELLED // Draft cancelled because a new inbound message arrived
}

model EmailIntegration {
  id                  Int                 @id @default(autoincrement())
  businessId          Int                 @unique
  provider            EmailProvider
  email               String // Connected email address
  credentials         Json // access_token, refresh_token, expiry
  connected           Boolean             @default(true)
  lastSyncedAt        DateTime?
  // Style Learning fields
  styleProfile        Json? // User's writing style profile
  styleAnalysisStatus StyleAnalysisStatus @default(PENDING)
  styleAnalyzedAt     DateTime?
  // Custom Email Signature
  emailSignature      String?             @db.Text // User's custom email signature (HTML or plain text)
  signatureType       SignatureType       @default(PLAIN) // PLAIN or HTML
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  business            Business            @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([provider])
}

enum SignatureType {
  PLAIN
  HTML
}

enum StyleAnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Email Sender Cache for Smart Filtering
model EmailSenderCache {
  id             String               @id @default(cuid())
  businessId     Int
  emailAddress   String // Sender's email address
  classification EmailClassification
  classifiedBy   ClassificationSource
  overriddenAt   DateTime? // If user manually overrode the classification
  createdAt      DateTime             @default(now())
  expiresAt      DateTime // 30 days from creation

  @@unique([businessId, emailAddress])
  @@index([businessId])
  @@index([emailAddress])
  @@index([expiresAt])
}

enum EmailClassification {
  PERSONAL
  AUTOMATED
}

enum ClassificationSource {
  HEURISTIC
  AI
  USER_OVERRIDE
}

model EmailThread {
  id            String            @id @default(cuid())
  businessId    Int
  threadId      String // Gmail/Outlook thread ID
  subject       String
  customerEmail String
  customerName  String?
  status        EmailThreadStatus @default(PENDING_REPLY)
  lastMessageAt DateTime
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  business      Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  messages      EmailMessage[]
  drafts        EmailDraft[]
  embeddings    EmailEmbedding[]

  @@unique([businessId, threadId])
  @@index([businessId])
  @@index([status])
  @@index([lastMessageAt])
}

model EmailMessage {
  id          String                @id @default(cuid())
  threadId    String
  messageId   String // Gmail/Outlook message ID
  direction   EmailMessageDirection
  fromEmail   String
  fromName    String?
  toEmail     String
  subject     String
  bodyText    String?               @db.Text
  bodyHtml    String?               @db.Text
  attachments Json? // [{name, size, mimeType}]
  isDraft     Boolean               @default(false)
  status      EmailMessageStatus    @default(RECEIVED)
  sentAt      DateTime?
  receivedAt  DateTime?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  thread      EmailThread           @relation(fields: [threadId], references: [id], onDelete: Cascade)
  drafts      EmailDraft[]

  @@unique([threadId, messageId])
  @@index([threadId])
  @@index([direction])
  @@index([status])
}

model EmailDraft {
  id               String           @id @default(cuid())
  messageId        String? // Which message this is replying to
  threadId         String
  businessId       Int
  generatedContent String           @db.Text // AI-generated draft
  editedContent    String?          @db.Text // User's edited version
  status           EmailDraftStatus @default(PENDING_REVIEW)
  metadata         Json? // Draft generation metadata (classification, tools, guardrails, RAG metrics)
  reviewedAt       DateTime?
  reviewedBy       Int? // User ID who reviewed
  sentAt           DateTime?
  sentMessageId    String? // ID of sent message
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  thread           EmailThread      @relation(fields: [threadId], references: [id], onDelete: Cascade)
  message          EmailMessage?    @relation(fields: [messageId], references: [id])
  business         Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([businessId])
  @@index([status])
}

// Email Draft Generation Lock (Idempotency)
// Prevents duplicate draft generation with DB-level guarantee
model EmailDraftLock {
  id              String    @id @default(cuid())
  businessId      Int
  threadId        String
  sourceMessageId String // The inbound message being replied to
  requestHash     String // Hash of request params for extra safety
  status          String    @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, FAILED
  draftId         String? // Reference to created draft (if completed)
  startedAt       DateTime  @default(now())
  completedAt     DateTime?
  expiresAt       DateTime // Auto-cleanup stale locks

  @@unique([businessId, threadId, sourceMessageId])
  @@index([expiresAt])
  @@index([status])
}

// ============================================================================
// EMAIL RAG & RETRIEVAL TABLES
// ============================================================================

// Email embeddings for RAG - Only SENT + successful emails
model EmailEmbedding {
  id         String  @id @default(cuid())
  businessId Int
  threadId   String
  messageId  String? // Null = thread-level embedding
  chunkIndex Int     @default(0) // For long emails split into chunks

  // Content (PII scrubbed before embedding)
  content     String @db.Text // The actual text that was embedded
  contentHash String // SHA256 of content for dedup/update detection

  // Embedding vector - stored as JSON array (Supabase pgvector via raw SQL)
  // For pgvector: use raw SQL to store as vector(1536)
  embeddingModel String   @default("text-embedding-3-small")
  embeddingDim   Int      @default(1536)
  embeddedAt     DateTime @default(now())

  // Metadata for filtering/ranking
  intent          String? // ORDER, BILLING, etc.
  language        String   @default("TR")
  recipientDomain String? // gmail.com, outlook.com, custom domain
  tags            String[] @default([])
  tokenCount      Int      @default(0)

  // Source tracking
  direction String // INBOUND or OUTBOUND
  sentAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  business Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  thread   EmailThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([threadId, messageId, chunkIndex])
  @@index([businessId])
  @@index([intent])
  @@index([language])
  @@index([contentHash])
  @@index([sentAt])
}

// Email Snippet Library - Admin-curated templates
model EmailSnippet {
  id         String  @id @default(cuid())
  businessId Int
  name       String // "Order Confirmation TR", "Complaint Response EN"
  intent     String // ORDER, BILLING, APPOINTMENT, COMPLAINT, INQUIRY, GENERAL
  language   String  @default("TR")
  tone       String  @default("professional") // professional, friendly, formal
  urgency    String? // LOW, MEDIUM, HIGH, CRITICAL - optional filter

  // Template content
  subject String? // Optional subject template
  body    String  @db.Text // The snippet body with variables

  // Variables: {customer_name}, {order_number}, {tracking_number}, etc.
  variables    String[] @default([]) // List of required variables
  optionalVars String[] @default([]) // Optional variables

  // Usage tracking
  usageCount Int       @default(0)
  lastUsedAt DateTime?
  enabled    Boolean   @default(true)

  // Metadata
  createdBy Int? // User ID who created
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, name])
  @@index([businessId])
  @@index([intent])
  @@index([language])
  @@index([enabled])
}

// ============================================================================
// WEBHOOK INTEGRATION TABLES
// ============================================================================

model WebhookConfig {
  id            Int      @id @default(autoincrement())
  businessId    Int      @unique
  webhookSecret String   @unique @default(cuid())
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([webhookSecret])
}

model WebhookLog {
  id           Int       @id @default(autoincrement())
  businessId   Int
  type         String // order, inventory, shipment, custom
  action       String? // created, updated, deleted
  payload      Json
  status       String    @default("received") // received, processed, failed
  errorMessage String?
  processedAt  DateTime?
  createdAt    DateTime  @default(now())

  @@index([businessId])
  @@index([type])
  @@index([createdAt])
}

model WebhookOrder {
  id              Int      @id @default(autoincrement())
  businessId      Int
  externalId      String
  customerName    String?
  customerPhone   String?
  customerEmail   String?
  status          String   @default("pending")
  statusText      String?
  totalAmount     Float?
  currency        String   @default("TRY")
  items           Json?
  trackingNumber  String?
  trackingCarrier String?
  trackingUrl     String?
  source          String   @default("webhook") // zapier, make, custom
  rawPayload      Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([businessId, externalId])
  @@index([businessId])
  @@index([customerPhone])
  @@index([customerEmail])
  @@index([externalId])
}

model WebhookInventory {
  id          Int      @id @default(autoincrement())
  businessId  Int
  externalId  String?
  productName String
  sku         String?
  stock       Int      @default(0)
  source      String   @default("webhook")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([businessId, sku])
  @@index([businessId])
  @@index([sku])
}

// ============================================================================
// BATCH CALL / COLLECTION CAMPAIGN TABLES
// ============================================================================

enum CampaignChannel {
  PHONE
  WHATSAPP
}

enum CampaignStatus {
  PENDING
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
  FAILED
}

enum CampaignCallStatus {
  PENDING
  QUEUED
  IN_PROGRESS
  COMPLETED
  FAILED
  NO_ANSWER
  BUSY
  VOICEMAIL
  SKIPPED
}

enum CampaignCallOutcome {
  PAYMENT_PROMISED // Ödeme sözü aldı
  PARTIAL_PAYMENT // Kısmi ödeme yapacak
  PAYMENT_REFUSED // Ödeme reddetti
  DISPUTE // İtiraz var
  CALLBACK_REQUESTED // Geri arama istedi
  WRONG_NUMBER // Yanlış numara
  NOT_AVAILABLE // Müsait değil
  NO_RESPONSE // Cevap yok
  OTHER // Diğer
}

// ============================================================================
// INVITE CODE & WAITLIST TABLES
// ============================================================================

model InviteCode {
  id          String    @id @default(cuid())
  code        String    @unique
  email       String? // Optional: for specific email
  used        Boolean   @default(false)
  usedBy      String? // User ID who used
  usedAt      DateTime?
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  createdById String? // Who created this code

  @@index([code])
  @@index([used])
}

model WaitlistEntry {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  company      String?
  businessType String?
  message      String?
  status       String   @default("pending") // pending, approved, rejected
  createdAt    DateTime @default(now())

  @@index([email])
  @@index([status])
}

model ContactMessage {
  id           String   @id @default(cuid())
  email        String
  name         String
  company      String?
  phone        String?
  businessType String?
  message      String?
  status       String   @default("new") // new, read, replied
  createdAt    DateTime @default(now())

  @@index([email])
  @@index([createdAt])
}

// ============================================================================
// KREDİ SİSTEMİ - YENİ MODELLER
// ============================================================================

model CreditPurchase {
  id         String   @id @default(cuid())
  businessId Int
  minutes    Int // Satın alınan dakika miktarı
  amount     Float // Ödenen tutar (TL)
  unitPrice  Float // Birim fiyat (TL/dk)
  paymentId  String? // iyzico payment ID
  status     String   @default("PENDING") // PENDING, COMPLETED, FAILED
  createdAt  DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([status])
  @@index([createdAt])
}

model UsageLog {
  id         String   @id @default(cuid())
  businessId Int
  type       String // CALL, WHATSAPP, CHAT, EMAIL
  minutes    Float // Dakika (çağrı için) veya 0 (diğerleri)
  source     String // PACKAGE, CREDIT, OVERAGE
  callId     String? // Call ID (11Labs conversation_id)
  metadata   Json? // Ek bilgiler (fromPackage, fromCredit, fromOverage)
  createdAt  DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// YENİ: KULLANIM KAYDI (UsageRecord) - Detaylı kullanım takibi
// ============================================================================

model UsageRecord {
  id              String   @id @default(cuid())
  subscriptionId  Int
  channel         String // PHONE, WHATSAPP, CHAT, EMAIL
  callId          String?  @unique // 11Labs conversation ID (telefon için) - P0-3: Idempotency constraint
  conversationId  String? // Diğer kanallar için
  durationSeconds Int // Saniye cinsinden süre
  durationMinutes Float // Dakika cinsinden süre
  chargeType      String // TRIAL, INCLUDED, BALANCE, OVERAGE, BALANCE_INCLUDED, etc.
  pricePerMinute  Float? // Uygulanan dakika fiyatı
  totalCharge     Float? // IMMEDIATE charge only (balance deduction). For split billing, full breakdown in metadata.chargeBreakdown (fromBalance, fromIncluded, overageMinutes)
  assistantId     String?
  metadata        Json? // Contains chargeBreakdown: { fromBalance, balanceCharge, fromIncluded, overageMinutes, overageRate }
  createdAt       DateTime @default(now())

  subscription       Subscription        @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  balanceTransaction BalanceTransaction?

  @@index([subscriptionId])
  @@index([channel])
  @@index([chargeType])
  @@index([createdAt])
}

// ============================================================================
// YENİ: BAKİYE HAREKETLERİ (BalanceTransaction)
// ============================================================================

model BalanceTransaction {
  id                    String   @id @default(cuid())
  subscriptionId        Int
  type                  String // TOPUP, USAGE, REFUND, OVERAGE
  amount                Float // + yükleme, - kullanım
  balanceBefore         Float
  balanceAfter          Float
  stripePaymentIntentId String? // Stripe ile yükleme için
  iyzicoPaymentId       String? // iyzico ile yükleme için
  usageRecordId         String?  @unique // Kullanım için
  description           String?
  createdAt             DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  usageRecord  UsageRecord? @relation(fields: [usageRecordId], references: [id])

  @@index([subscriptionId])
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// CRM WEBHOOK INTEGRATION TABLES
// ============================================================================

// CRM Webhook Config
model CrmWebhook {
  id            String    @id @default(cuid())
  businessId    Int       @unique
  webhookSecret String    @unique @default(cuid())
  isActive      Boolean   @default(true)
  lastDataAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

// CRM Webhook Event (Idempotency tracking)
model CrmWebhookEvent {
  id              String   @id @default(cuid())
  idempotencyKey  String   @unique  // Format: businessId-type-eventId
  businessId      Int
  eventType       String   // order, stock, ticket
  eventId         String   // External event ID from CRM system
  recordId        String   // ID of created CrmOrder/CrmStock/CrmTicket
  processedAt     DateTime @default(now())

  business Business @relation("CrmWebhookEvents", fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, eventType])
  @@index([processedAt])
}

// CRM Sipariş Verileri
model CrmOrder {
  id                String    @id @default(cuid())
  businessId        Int
  orderNumber       String
  customerPhone     String
  customerName      String?
  customerEmail     String?
  status            String
  trackingNumber    String?
  carrier           String?
  items             Json?
  totalAmount       Float?
  estimatedDelivery DateTime?
  externalUpdatedAt DateTime
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, orderNumber])
  @@index([businessId, customerPhone])
  @@index([businessId, customerEmail])
}

// CRM Stok Verileri
model CrmStock {
  id                String    @id @default(cuid())
  businessId        Int
  sku               String
  productName       String
  inStock           Boolean
  quantity          Int?
  price             Float?
  estimatedRestock  DateTime?
  externalUpdatedAt DateTime
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, sku])
  @@index([businessId, productName])
}

// CRM Servis/Arıza Verileri
model CrmTicket {
  id                  String    @id @default(cuid())
  businessId          Int
  ticketNumber        String
  customerPhone       String
  customerName        String?
  product             String
  issue               String?
  status              String
  notes               String?
  estimatedCompletion DateTime?
  cost                Float?
  externalUpdatedAt   DateTime
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, ticketNumber])
  @@index([businessId, customerPhone])
}

// ============================================================================
// BATCH CALL (Excel/CSV Upload Based)
// ============================================================================

enum BatchCallStatus {
  PENDING // Waiting to start
  IN_PROGRESS // Currently running
  COMPLETED // All calls completed
  FAILED // Failed to process
  CANCELLED // Cancelled by user
}

model BatchCall {
  id                String          @id @default(cuid())
  businessId        Int
  assistantId       String
  phoneNumberId     String? // Phone number used for outbound calls
  name              String // Campaign name
  elevenLabsBatchId String? // 11Labs Batch Call ID
  status            BatchCallStatus @default(PENDING)
  totalRecipients   Int             @default(0)
  completedCalls    Int             @default(0)
  successfulCalls   Int             @default(0)
  failedCalls       Int             @default(0)
  recipients        String          @db.Text // JSON array of recipients
  columnMapping     String?         @db.Text // JSON column mapping config
  scheduledAt       DateTime? // If scheduled for later
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  business    Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  assistant   Assistant    @relation(fields: [assistantId], references: [id], onDelete: Cascade)
  phoneNumber PhoneNumber? @relation(fields: [phoneNumberId], references: [id])

  @@index([businessId])
  @@index([status])
  @@index([assistantId])
  @@index([createdAt])
}

// ============================================================================
// GERİ ARAMA TALEPLERİ (CALLBACK REQUESTS)
// Asistan müşteriye yardımcı olamadığında veya müşteri gerçek biriyle
// görüşmek istediğinde oluşturulan geri arama kayıtları
// ============================================================================

model CallbackRequest {
  id String @id @default(cuid())

  // İlişkiler
  businessId  Int
  business    Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  assistantId String?
  assistant   Assistant? @relation(fields: [assistantId], references: [id], onDelete: SetNull)
  callId      String? // İlgili arama kaydı (conversation_id)

  // Müşteri bilgileri
  customerName  String
  customerPhone String
  topic         String // Konu özeti
  topicHash     String? // Topic hash for duplicate detection (16-char SHA256)

  // Durum
  status   CallbackStatus   @default(PENDING)
  priority CallbackPriority @default(NORMAL)

  // Notlar
  notes         String? @db.Text // İşletme notları
  callbackNotes String? @db.Text // Geri arama sonrası notlar

  // Zaman
  requestedAt  DateTime  @default(now())
  scheduledFor DateTime? // Planlanan arama zamanı (opsiyonel)
  completedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([status])
  @@index([priority])
  @@index([requestedAt])
  @@index([customerPhone, topicHash, requestedAt]) // Duplicate detection index
}

model DoNotCall {
  id        String   @id @default(cuid())
  businessId Int
  phoneE164 String
  source    String   @default("PHONE_OUTBOUND_V1")
  createdAt DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, phoneE164])
  @@index([businessId])
  @@index([phoneE164])
  @@index([createdAt])
}

enum CallbackStatus {
  PENDING // Bekliyor
  IN_PROGRESS // Aranıyor
  COMPLETED // Tamamlandı
  NO_ANSWER // Cevap vermedi
  CANCELLED // İptal edildi
}

enum CallbackPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ============================================================================
// MÜŞTERİ VERİ TABANI (CUSTOMER DATA)
// Müşteri telefon numarasına göre eşleştirme yapılarak AI asistan tarafından
// kullanılan özel müşteri verileri. Excel/CSV ile toplu yükleme destekli.
// ============================================================================

model CustomerDataFile {
  id String @id @default(cuid())

  // İlişki
  businessId Int
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Dosya bilgileri
  fileName    String // Orijinal dosya adı (siparis_listesi.xlsx)
  dataType    String // Veri tipi (accounting, support, order, customer, custom)
  recordCount Int    @default(0) // Dosyadaki kayıt sayısı

  // Sütun yapısı
  columns Json // Dosyadaki sütun isimleri [{name: "Telefon", key: "phone"}, ...]

  // Durum
  status CustomerDataFileStatus @default(PROCESSING)

  // Zaman damgaları
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // İlişkiler
  records CustomerData[]

  @@index([businessId])
  @@index([dataType])
  @@index([status])
  @@index([createdAt])
}

enum CustomerDataFileStatus {
  PROCESSING // İşleniyor
  ACTIVE // Aktif, kullanılabilir
  FAILED // İşlem başarısız
}

model CustomerData {
  id String @id @default(cuid())

  // İlişki
  businessId Int
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Dosya ilişkisi
  fileId String? // Hangi dosyadan geldiği
  file   CustomerDataFile? @relation(fields: [fileId], references: [id], onDelete: Cascade)

  // Temel bilgiler (zorunlu alanlar)
  companyName String // İşletme/Şirket adı veya müşteri adı
  phone       String // Telefon (eşleştirme için kritik)

  // İletişim bilgileri
  contactName String? // Yetkili kişi adı
  email       String? // Email

  // Kimlik bilgileri
  vkn     String? // Vergi Kimlik No
  tcNo    String? // TC Kimlik No (şahıs firması ise)
  orderNo String? // Sipariş numarası (P0.2b: normalized uppercase)

  // Özel alanlar - JSON formatında esnek veri
  // Mali veriler, borç bilgileri, beyanname durumları vb. burada tutulur
  customFields Json? // { sgkDebt: 15750, taxDebt: 8320, ... }

  // Ek bilgiler
  notes String? // Serbest notlar
  tags  String[] @default([]) // Etiketler (kategorilendirme için)

  // Zaman damgaları
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Aynı müşterinin birden fazla kaydı olabilir (farklı siparişler, borçlar vb.)
  @@index([businessId])
  @@index([businessId, phone]) // Telefona göre hızlı arama
  @@index([businessId, email]) // Email ile identity proof lookup
  @@index([vkn])
  @@index([fileId])
}

// ============================================================================
// ADMİN PANELİ MODELLERİ
// ============================================================================

model AdminUser {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String
  role      AdminRole  @default(ADMIN)
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  lastLogin DateTime?
  auditLogs AuditLog[]

  @@index([email])
  @@index([role])
}

enum AdminRole {
  SUPER_ADMIN // Tüm yetkiler
  ADMIN // Standart admin
  SUPPORT // Sadece görüntüleme + sınırlı düzenleme
}

model AuditLog {
  id         String      @id @default(cuid())
  adminId    String
  admin      AdminUser   @relation(fields: [adminId], references: [id])
  adminEmail String // Denormalize - hızlı görüntüleme için
  action     AuditAction
  entityType String // "User", "Business", "Assistant", "Subscription" vb.
  entityId   String // İlgili kaydın ID'si
  changes    Json? // { field: { old: x, new: y } }
  metadata   Json? // Ek bilgiler
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now())

  @@index([adminId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

enum AuditAction {
  VIEW
  CREATE
  UPDATE
  DELETE
  LOGIN
  PASSWORD_RESET
  PLAN_CHANGE
  SUSPEND
  ACTIVATE
  ACCESS_DENIED
}

// ============================================================================
// BUSINESS AUDIT LOG (P1 - Team Management Events)
// ============================================================================

model BusinessAuditLog {
  id           String   @id @default(cuid())
  action       String // invitation_created, invitation_accepted, role_changed, member_removed, login_failed
  actorUserId  Int?
  businessId   Int
  targetUserId Int?
  targetEmail  String?
  metadata     Json? // { role, oldRole, newRole, reason, etc }
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  // Relations
  actor    User?    @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  target   User?    @relation("AuditTarget", fields: [targetUserId], references: [id], onDelete: SetNull)

  @@index([businessId])
  @@index([actorUserId])
  @@index([action])
  @@index([createdAt])
}

// ============================================================================
// CONVERSATION STATE MACHINE MODELS
// ============================================================================

// Session mapping: Maps channel-specific user IDs to universal session IDs
// Prevents PII in sessionId and handles multi-channel conversations
model SessionMapping {
  id            String   @id @default(cuid())
  sessionId     String   @unique // Universal session ID (conv_${uuid})
  businessId    Int
  channel       String // CHAT, WHATSAPP, PHONE
  channelUserId String // Channel-specific ID (wa_id, widget session, call id)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([businessId, channel, channelUserId])
  @@index([sessionId])
  @@index([businessId, channel])
}

// Conversation state: Stores full state machine state for each session
model ConversationState {
  id         String @id @default(cuid())
  sessionId  String @unique
  businessId Int

  // Full state stored as JSON
  state Json // { activeFlow, flowStatus, expectedSlot, collectedSlots, verification, allowedTools, ... }

  // TTL for cleanup
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([expiresAt]) // For cleanup cron
}

// Customer Identity: Canonical customer identity (Phase 4)
// Prevents data duplication across CrmOrder, CrmTicket, CustomerData, etc.
model CustomerIdentity {
  id         String @id @default(cuid())
  businessId Int

  // Primary identifiers (normalized)
  primaryPhone String // Normalized: 905xxxxxxxxx format
  primaryEmail String? // Normalized: lowercase

  // Display information
  displayName String // Customer/Company name for display

  // External references (JSON for flexibility)
  externalRefs Json? // { shopifyId, ikasId, crmId, erpId, ... }

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([businessId, primaryPhone])
  @@index([businessId])
  @@index([primaryPhone])
  @@index([primaryEmail])
}

// Tool Execution Idempotency (restart-safe)
model ToolExecution {
  id String @id @default(cuid())

  // Composite key for idempotency
  businessId Int
  channel    String // 'CHAT' | 'WHATSAPP' | 'PHONE'
  messageId  String // Webhook message ID
  toolName   String // Tool that was executed

  // Result cache
  success Boolean
  data    Json? // Tool result data
  error   String? // Error message if failed

  // Timestamps
  createdAt DateTime @default(now())
  expiresAt DateTime // TTL: createdAt + 1 hour

  @@unique([businessId, channel, messageId, toolName])
  @@index([businessId])
  @@index([expiresAt]) // For cleanup
}

// Outbound Message Idempotency (prevents duplicate sends)
model OutboundMessage {
  id String @id @default(cuid())

  // Composite key for idempotency
  businessId       Int
  channel          String // 'WHATSAPP' | 'SMS' | 'EMAIL'
  recipientId      String // Phone number or email
  inboundMessageId String // Original webhook message ID that triggered this

  // Send result
  sent       Boolean @default(true)
  externalId String? // WhatsApp message ID, email ID, etc.

  // Timestamps
  createdAt DateTime @default(now())
  expiresAt DateTime // TTL: createdAt + 1 hour

  @@unique([businessId, channel, recipientId, inboundMessageId])
  @@index([businessId])
  @@index([expiresAt]) // For cleanup
}

// Pilot Business Allowlist (Controlled Feature Rollout)
model PilotBusiness {
  id         String   @id @default(cuid())
  businessId Int
  feature    String // 'RAG_PILOT' | 'SNIPPET_PILOT' | 'AUTO_DRAFT'
  enabledAt  DateTime @default(now())
  enabledBy  String // Admin user email who enabled this
  notes      String? // Optional notes (cohort, vertical, contact)

  business Business @relation("PilotBusinesses", fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, feature]) // Prevent duplicate feature entries
  @@index([feature, businessId]) // Query index for getPilotBusinesses()
}

// Email Pair (INBOUND → OUTBOUND) - Learning Dataset
// Used for tone matching, signature patterns, and style learning
model EmailPair {
  id                String @id @default(cuid())
  businessId        Int
  threadId          String
  inboundMessageId  String // The incoming email
  outboundMessageId String // Our reply to it

  // Extracted features for matching
  inboundTone    String? // formal / neutral / casual / angry
  outboundTone   String? // formal / neutral / casual
  closingPattern String? // "Best regards", "Thanks", "Cheers", etc.
  signatureUsed  String? @db.Text // Full signature block from outbound
  lengthBucket   String? // short / medium / long

  // Metadata for filtering
  contactType String? // customer / business / personal
  fromDomain  String? // Sender's email domain
  intent      String? // COMPLAINT / INQUIRY / REQUEST / etc.
  language    String? // TR / EN

  // Cleaned content (quoted text + signatures removed)
  inboundText  String @db.Text
  outboundText String @db.Text

  // Original content (for reference)
  inboundRaw  String? @db.Text
  outboundRaw String? @db.Text

  // Analysis metadata
  confidence Float    @default(1.0) // Match confidence (0-1)
  analyzedAt DateTime @default(now())

  // Timestamps
  sentAt    DateTime // When the outbound was sent
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business @relation("EmailPairs", fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, inboundMessageId, outboundMessageId])
  @@index([businessId, inboundTone])
  @@index([businessId, intent, language])
  @@index([threadId])
  @@index([sentAt])
}

// ============================================================================
// OAUTH STATE MANAGEMENT (CSRF Protection)
// ============================================================================
model OAuthState {
  id         Int      @id @default(autoincrement())
  state      String   @unique // Cryptographically random token
  businessId Int
  provider   String   // google, microsoft, hubspot, etc.
  metadata   Json?    // Additional data (redirectUrl, integrationId, etc.)
  expiresAt  DateTime // 10-minute expiry
  createdAt  DateTime @default(now())

  business Business @relation("OAuthStates", fields: [businessId], references: [id], onDelete: Cascade)

  @@index([state])
  @@index([businessId, provider])
  @@index([expiresAt]) // For cleanup cron
}

// ============================================================================
// SECURITY EVENT TRACKING (For Red Alert & Monitoring)
// ============================================================================
model SecurityEvent {
  id          Int      @id @default(autoincrement())
  type        String   // cross_tenant_attempt, firewall_block, content_safety_block, ssrf_block, auth_failure, rate_limit_hit
  severity    String   // low, medium, high, critical
  businessId  Int?     // null if request before auth
  userId      Int?     // null if request before auth
  ipAddress   String?
  userAgent   String?
  endpoint    String?
  method      String?  // GET, POST, etc.
  statusCode  Int?     // Response status
  details     Json?    // Additional context (blocked reason, attempted action, etc.)
  createdAt   DateTime @default(now())

  @@index([type, createdAt])
  @@index([severity, createdAt])
  @@index([businessId, createdAt])
  @@index([createdAt]) // For time-range queries
}

// ============================================================================
// ERROR LOG (For Error Tracking Center in Red Alert)
// ============================================================================
// Captures all application errors: tool failures, chat errors, API errors, etc.
// Separate from SecurityEvent — different dedup logic, different fields, different retention.
model ErrorLog {
  id              Int      @id @default(autoincrement())

  // Classification (SSOT enums in errorLogger.js)
  category        String   // tool_failure, chat_error, assistant_error, api_error, system_error, webhook_error
  severity        String   // low, medium, high, critical
  errorCode       String?  // Application-specific: GEMINI_TIMEOUT, 11LABS_RATE_LIMIT, etc.

  // Error details (PII-redacted by redact.js before insert)
  message         String   // Sanitized error message
  stackTrace      String?  @db.Text  // Sanitized stack trace (max 2000 chars)

  // Context
  businessId      Int?
  userId          Int?
  requestId       String?  // Correlation with req.requestId
  sessionId       String?  // Chat/WhatsApp session ID

  // Source identification
  source          String   // Where error occurred: chat-refactored, tools/index, routes/assistant, etc.
  endpoint        String?
  method          String?

  // Tool-specific
  toolName        String?

  // External API-specific
  externalService String?  // SSOT enum: gemini, elevenlabs, gmail, etc.
  externalStatus  Int?     // HTTP status from external API
  responseTimeMs  Int?

  // Deduplication
  fingerprint     String?  // Hash of (category+source+errorCode+normalizedMessage)
  occurrenceCount Int      @default(1)
  firstSeenAt     DateTime @default(now())  // First occurrence (never updated on dedup)
  lastSeenAt      DateTime @default(now())  // Latest occurrence (updated on dedup)
  latestRequestId String?  // RequestId of most recent occurrence

  // Resolution
  resolved        Boolean  @default(false)
  resolvedAt      DateTime?
  resolvedBy      String?  // Admin email

  createdAt       DateTime @default(now())

  @@index([category, createdAt])
  @@index([severity, createdAt])
  @@index([businessId, createdAt])
  @@index([source, createdAt])
  @@index([externalService, createdAt])
  @@index([fingerprint, createdAt])
  @@index([resolved, createdAt])
  @@index([createdAt])
}
