/**
 * Step 2: Prepare Context
 *
 * - Build system prompt
 * - Get conversation history (single source)
 * - Get active tools
 */

import { buildAssistantPrompt, getActiveTools as getPromptBuilderTools } from '../../../services/promptBuilder.js';
import { getDateTimeContext } from '../../../utils/dateTime.js';
import { getActiveTools } from '../../../tools/index.js';
import { retrieveKB } from '../../../services/kbRetrieval.js'; // V1 MVP: Intelligent KB retrieval
import { formatBusinessIdentityForPrompt } from '../../../services/businessIdentity.js';

export async function prepareContext(params) {
  const {
    business,
    assistant,
    state,
    language,
    timezone,
    prisma,
    sessionId,
    userMessage,
    channelMode,
    businessIdentity,
    entityResolution
  } = params;

  // Build system prompt
  const activeToolsList = getPromptBuilderTools(business, business.integrations || []);
  const systemPromptBase = buildAssistantPrompt(assistant, business, activeToolsList, {
    businessIdentity
  });
  const dateTimeContext = getDateTimeContext(timezone, language);

  // Entity-first retrieval (top-N query terms, deterministic)
  const kbResult = await retrieveKB(business.id, userMessage || '', {
    entityResolution
  });
  const knowledgeContext = kbResult.context || '';
  const kbConfidence = kbResult.kbConfidence || 'LOW';

  // KB match flag: In KB_ONLY mode, router uses this to decide redirect vs LLM answer.
  // LOW confidence means entity is likely not represented in KB.
  const hasKBMatch = kbConfidence !== 'LOW' && !!(knowledgeContext && knowledgeContext.trim().length > 50);

  const identityContext = formatBusinessIdentityForPrompt(businessIdentity, language);
  const groundingContext = String(language || 'TR').toUpperCase() === 'TR'
    ? `## GROUNDING DURUMU
- KB_CONFIDENCE: ${kbConfidence}

Kurallar:
- Åžirket/Ã¼rÃ¼n/Ã¶zellik claim'leri iÃ§in KB veya tool kanÄ±tÄ± yoksa iddia kurma.
- BUSINESS_CLAIM kategorisinde KB match yoksa asla sektÃ¶r/Ã¶zellik/hizmet iddiasÄ± Ã¼retme.
- KB_CONFIDENCE LOW ise "Bu konuda elimde doÄŸrulanmÄ±ÅŸ bilgi yok" de ve TEK netleÅŸtirme sorusu sor.
- Genel dÃ¼nya bilgisinden ÅŸirket tanÄ±mÄ± uydurma.
- Belirsizlikte yÃ¶nlendir: "${businessIdentity?.businessName || business.name} ile ilgili hangi konuyu soruyorsun?"`
    : `## GROUNDING STATUS
- KB_CONFIDENCE: ${kbConfidence}

Rules:
- Do not make company/product/feature claims without KB or tool evidence.
- In BUSINESS_CLAIM category, if there is no KB match, never assert features/industry claims.
- If KB_CONFIDENCE is LOW, say you do not have verified information and ask exactly one clarification question.
- Do not infer company descriptions from general world knowledge.
- In ambiguity ask: "Which topic about ${businessIdentity?.businessName || business.name} are you asking about?"`;

  const fullSystemPrompt = `${dateTimeContext}\n\n${identityContext}\n\n${groundingContext}\n\n${systemPromptBase}\n\n${knowledgeContext}`;

  // Get conversation history (SINGLE SOURCE: ChatLog table)
  const chatLog = await prisma.chatLog.findUnique({
    where: { sessionId },
    select: { messages: true }
  });

  const conversationHistory = chatLog?.messages || [];

  // Get tools filtered by business type and integrations
  let toolsAll = getActiveTools(business);

  // KB_ONLY: Strip all tools â€” LLM should only use KB
  if (channelMode === 'KB_ONLY') {
    toolsAll = [];
    console.log('ðŸ”’ [PrepareContext] KB_ONLY mode â€” all tools stripped');
  }

  return {
    systemPrompt: fullSystemPrompt,
    conversationHistory,
    toolsAll,
    hasKBMatch,
    kbConfidence,
    retrievalMetadata: kbResult
  };
}

export default { prepareContext };
