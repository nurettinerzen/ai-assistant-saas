/**
 * Step 4: Tool Gating for Email
 *
 * Determines which tools are available for this email draft.
 *
 * CRITICAL RULES:
 * 1. Only READ-ONLY tools during draft generation
 * 2. No write operations (create_callback, create_appointment, etc.)
 * 3. Tools gated by:
 *    - Classification (needs_tools)
 *    - Business integrations
 *    - Confidence level
 */

import { getActiveTools } from '../../../tools/index.js';

// Tools that are READ-ONLY and safe for email draft generation
const EMAIL_SAFE_TOOLS = [
  'customer_data_lookup',
  'product_stock',
  'order_status',
  'appointment_lookup',
  'crm_contact_lookup',
  'crm_deal_lookup'
];

// Tools that are WRITE operations - NOT allowed during draft
const EMAIL_BLOCKED_TOOLS = [
  'create_callback',
  'create_appointment',
  'update_appointment',
  'cancel_appointment',
  'order_notification',
  'crm_create_contact',
  'crm_update_contact',
  'crm_create_deal',
  'crm_update_deal'
];

/**
 * Gate tools for email draft generation
 *
 * @param {Object} ctx - Pipeline context
 * @returns {Promise<Object>} { success }
 */
export async function gateEmailTools(ctx) {
  const { business, classification } = ctx;

  try {
    // Get all active tools for this business
    const allTools = getActiveTools(business);

    if (!allTools || allTools.length === 0) {
      ctx.gatedTools = [];
      ctx.gatedToolDefs = [];
      console.log('üìß [ToolGating] No tools available for this business');
      return { success: true };
    }

    // Filter to only email-safe tools
    let gatedTools = allTools.filter(tool => {
      const toolName = tool.function?.name || tool.name;
      return EMAIL_SAFE_TOOLS.includes(toolName) && !EMAIL_BLOCKED_TOOLS.includes(toolName);
    });

    // If classification says no tools needed, disable all
    if (!classification.needs_tools) {
      console.log('üìß [ToolGating] Classification indicates no tools needed');
      ctx.gatedTools = [];
      ctx.gatedToolDefs = [];
      return { success: true };
    }

    // If low confidence, reduce tools to minimal set
    if (classification.confidence < 0.6) {
      console.log('üìß [ToolGating] Low confidence - limiting to lookup tools only');
      gatedTools = gatedTools.filter(tool => {
        const toolName = tool.function?.name || tool.name;
        return toolName === 'customer_data_lookup';
      });
    }

    // Extract tool names for logging and state
    ctx.gatedTools = gatedTools.map(t => t.function?.name || t.name);
    ctx.gatedToolDefs = gatedTools;

    console.log(`üìß [ToolGating] Gated tools: ${ctx.gatedTools.join(', ') || 'none'}`);

    // Log blocked tools for debugging
    const requestedButBlocked = allTools
      .filter(t => {
        const name = t.function?.name || t.name;
        return EMAIL_BLOCKED_TOOLS.includes(name);
      })
      .map(t => t.function?.name || t.name);

    if (requestedButBlocked.length > 0) {
      console.log(`üìß [ToolGating] Blocked write tools: ${requestedButBlocked.join(', ')}`);
    }

    return { success: true };

  } catch (error) {
    console.error('‚ùå [ToolGating] Error:', error);

    // Fail-closed: no tools on error
    ctx.gatedTools = [];
    ctx.gatedToolDefs = [];

    return { success: true }; // Don't fail pipeline, just disable tools
  }
}

/**
 * Check if a specific tool is allowed for email
 *
 * @param {string} toolName
 * @returns {boolean}
 */
export function isToolAllowedForEmail(toolName) {
  return EMAIL_SAFE_TOOLS.includes(toolName) && !EMAIL_BLOCKED_TOOLS.includes(toolName);
}

export default { gateEmailTools, isToolAllowedForEmail };
