/**
 * create_callback Tool Handler
 * Geri arama kaydƒ± olu≈üturur.
 */

import { PrismaClient } from '@prisma/client';
import { GoogleGenerativeAI } from '@google/generative-ai';
import { ok, systemError, ToolOutcome } from '../toolResult.js';
import crypto from 'crypto';

const prisma = new PrismaClient();

/**
 * Normalize topic for duplicate detection
 * Removes common punctuation, lowercases, trims
 */
function normalizeTopic(topic) {
  return topic
    .toLowerCase()
    .replace(/[.,!?;:\-]/g, '') // Remove punctuation
    .replace(/\s+/g, ' ') // Normalize whitespace
    .trim();
}

/**
 * Generate hash from normalized topic
 */
function generateTopicHash(topic) {
  const normalized = normalizeTopic(topic);
  return crypto.createHash('sha256').update(normalized).digest('hex').substring(0, 16);
}

/**
 * Generate topic from conversation context (deterministic)
 * Extracts key information from state and recent messages
 */
function generateTopicFromContext(context, language) {
  const state = context.state || {};
  const extractedSlots = state.extractedSlots || {};

  // Build topic from available context
  const topicParts = [];

  // 1. Check for order-related context
  if (extractedSlots.order_number) {
    topicParts.push(
      language === 'TR'
        ? `Sipari≈ü ${extractedSlots.order_number}`
        : `Order ${extractedSlots.order_number}`
    );
  }

  // 2. Check for complaint/issue indicators
  const complaintIndicators = [
    'teslim almadƒ±m', 'gelmedi', 'ula≈ümadƒ±', 'problem', 'sorun',
    '≈üikayet', 'itiraz', 'yanlƒ±≈ü', 'hatalƒ±', 'eksik'
  ];

  const recentMessages = context.conversationHistory?.slice(-6) || [];
  const hasComplaint = recentMessages.some(msg =>
    msg.role === 'user' && complaintIndicators.some(indicator =>
      msg.content?.toLowerCase().includes(indicator)
    )
  );

  if (hasComplaint) {
    topicParts.push(
      language === 'TR' ? 'hakkƒ±nda sorun' : 'issue'
    );
  }

  // 3. Check for callback/manager request
  const callbackIndicators = ['y√∂netici', 'yetkili', 'geri ara', 'ara beni', 'callback'];
  const hasCallbackRequest = recentMessages.some(msg =>
    msg.role === 'user' && callbackIndicators.some(indicator =>
      msg.content?.toLowerCase().includes(indicator)
    )
  );

  if (hasCallbackRequest && topicParts.length === 0) {
    topicParts.push(
      language === 'TR' ? 'Genel g√∂r√º≈üme talebi' : 'General inquiry'
    );
  }

  // 4. Fallback: Use last user message snippet
  if (topicParts.length === 0) {
    const lastUserMessage = recentMessages
      .filter(msg => msg.role === 'user')
      .pop();

    if (lastUserMessage?.content) {
      const snippet = lastUserMessage.content.substring(0, 50);
      topicParts.push(snippet);
    } else {
      topicParts.push(
        language === 'TR' ? 'M√º≈üteri talebi' : 'Customer request'
      );
    }
  }

  return topicParts.join(' - ');
}

/**
 * Redact PII from text before sending to LLM
 * Masks phone numbers, emails, dates, Turkish ID numbers
 */
function redactPII(text) {
  if (!text) return '';
  return text
    .replace(/\b\d{10,11}\b/g, '[TEL]')                      // phone numbers (10-11 digits)
    .replace(/\b[\w.-]+@[\w.-]+\.\w+\b/g, '[EMAIL]')         // email addresses
    .replace(/\b\d{1,3}[./]\d{1,3}[./]\d{2,4}\b/g, '[DATE]') // date patterns
    .replace(/\bTC?\s?\d{11}\b/gi, '[TCKN]');                 // Turkish ID number
}

/**
 * Generate topic summary using LLM (gemini-2.0-flash-lite)
 * PII is redacted before sending to model.
 * Returns null on failure (caller should fallback to keyword-based).
 */
async function generateTopicWithLLM(conversationHistory, language) {
  const recentMessages = (conversationHistory || []).slice(-10);
  if (recentMessages.length === 0) return null;

  // PII redaction before sending to LLM
  const transcript = recentMessages
    .map(m => `${m.role === 'user' ? 'M√º≈üteri' : 'Asistan'}: ${redactPII(m.content || '')}`)
    .join('\n');

  const prompt = language === 'TR'
    ? `A≈üaƒüƒ±daki m√º≈üteri-asistan konu≈ümasƒ±nƒ± 1 c√ºmle ile √∂zetle. Maksimum 100 karakter. Sadece konuyu belirt. √ñrnek: "Sipari≈ü kargo gecikmesi sorunu"\n\n${transcript}`
    : `Summarize this customer-assistant conversation in 1 sentence. Max 100 chars. Topic only. Example: "Order shipping delay issue"\n\n${transcript}`;

  const genAI = new GoogleGenerativeAI(process.env.GOOGLE_AI_API_KEY);
  const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-lite' });

  const result = await model.generateContent(prompt);
  const summary = result.response?.text()?.trim();

  if (!summary || summary.length === 0) return null;
  return summary.length <= 160 ? summary : summary.substring(0, 157) + '...';
}

// Generic topic values that indicate keyword-based generation was inconclusive
const GENERIC_TOPICS = [
  'M√º≈üteri talebi', 'Customer request',
  'Genel g√∂r√º≈üme talebi', 'General inquiry'
];

const PLACEHOLDER_NAMES = new Set([
  'customer',
  'unknown',
  'anonim',
  'anonymous',
  'test',
  '-',
  'n/a',
  'na'
]);

function isPlaceholderName(name) {
  if (!name) return true;
  const normalized = String(name).trim().toLowerCase();
  return !normalized || PLACEHOLDER_NAMES.has(normalized);
}

function buildCallbackValidationError(language, missingFields) {
  const askFor = missingFields.length > 0 ? missingFields : ['customer_name', 'phone'];
  return {
    outcome: ToolOutcome.VALIDATION_ERROR,
    success: true,
    validationError: true,
    askFor,
    data: { askFor },
    message: language === 'TR'
      ? 'Sizi arayabilmemiz i√ßin ad-soyad ve telefon numaranƒ±zƒ± payla≈üƒ±r mƒ±sƒ±nƒ±z?'
      : 'To create your callback, could you share your full name and phone number?'
  };
}

export default {
  name: 'create_callback',

  async execute(args, business, context = {}) {
    try {
      let { customerName, customerPhone, topic, priority = 'NORMAL' } = args;
      const language = business.language || 'TR';

      // Deterministic contract: callback cannot proceed without real name + phone.
      const missing = [];
      if (isPlaceholderName(customerName)) {
        missing.push('customer_name');
      }
      if (!customerPhone || String(customerPhone).trim() === '') {
        missing.push('phone');
      }
      if (missing.length > 0) {
        return buildCallbackValidationError(language, missing);
      }

      // AUTO-GENERATE TOPIC: If not provided, infer from conversation context
      // Strategy: Deterministic (keyword) first ‚Üí LLM fallback only if generic
      if (!topic || topic.trim().length === 0) {
        // 1) Deterministic: keyword-based (fast, free, reliable)
        topic = generateTopicFromContext(context, language);
        console.log(`üîß [create_callback] Keyword-generated topic: "${topic}"`);

        // 2) LLM fallback: only if keyword gave a generic result AND we have conversation context
        const isGenericTopic = GENERIC_TOPICS.some(g => topic === g);
        if (isGenericTopic && context.conversationHistory?.length > 2) {
          try {
            const llmTopic = await Promise.race([
              generateTopicWithLLM(context.conversationHistory, language),
              new Promise((_, reject) => setTimeout(() => reject(new Error('LLM topic timeout')), 5000))
            ]);
            if (llmTopic) {
              topic = llmTopic;
              console.log(`ü§ñ [create_callback] LLM-generated topic: "${topic}"`);
            }
          } catch (err) {
            console.warn(`‚ö†Ô∏è [create_callback] LLM topic failed, using keyword: ${err.message}`);
          }
        }
      }

      // Ensure topic is not too long (max 160 chars for readability)
      if (topic.length > 160) {
        topic = topic.substring(0, 157) + '...';
      }

      // Generate topic hash for duplicate detection
      const topicHash = generateTopicHash(topic);

      // DUPLICATE GUARD: Check for recent callback with same phone + topic hash
      // Time window: 15 minutes
      // Uses composite index: [customerPhone, topicHash, requestedAt]
      const fifteenMinutesAgo = new Date(Date.now() - 15 * 60 * 1000);

      const recentCallback = await prisma.callbackRequest.findFirst({
        where: {
          businessId: business.id,
          customerPhone,
          topicHash, // Use hash in query for index performance
          status: 'PENDING',
          requestedAt: {
            gte: fifteenMinutesAgo
          }
        },
        orderBy: {
          requestedAt: 'desc'
        }
      });

      if (recentCallback) {
        console.log(`üîí [create_callback] Duplicate detected: ${recentCallback.id} (same phone + topic within 15min)`);

        return ok(
          { callbackId: recentCallback.id, status: 'PENDING', isDuplicate: true },
          language === 'TR'
            ? `Talebiniz zaten kaydedildi. Yeni bir kayƒ±t a√ßmadƒ±m. ${customerName} en kƒ±sa s√ºrede aranacak.`
            : `Your request is already registered. I did not create a new record. ${customerName} will be called back shortly.`
        );
      }

      // Priority validasyonu
      const validPriorities = ['LOW', 'NORMAL', 'HIGH', 'URGENT'];
      const finalPriority = validPriorities.includes(priority) ? priority : 'NORMAL';

      // Callback olu≈ütur
      const callback = await prisma.callbackRequest.create({
        data: {
          businessId: business.id,
          assistantId: context.assistantId || null,
          callId: context.conversationId || null, // callId = ChatLog.sessionId (links callback ‚Üí chat)
          customerName,
          customerPhone,
          topic,
          topicHash, // Store hash for future duplicate detection
          priority: finalPriority
        }
      });

      console.log(`‚úÖ Callback created via tool: ${callback.id} for business ${business.id}`);

      return ok(
        { callbackId: callback.id, status: 'PENDING' },
        language === 'TR'
          ? `Geri arama kaydƒ± olu≈üturuldu. ${customerName} en kƒ±sa s√ºrede aranacak.`
          : `Callback request created. ${customerName} will be called back shortly.`
      );

    } catch (error) {
      console.error('‚ùå create_callback error:', error);
      return systemError(
        business.language === 'TR'
          ? 'Geri arama kaydƒ± olu≈üturulamadƒ±. L√ºtfen tekrar deneyin.'
          : 'Could not create callback request. Please try again.',
        error
      );
    }
  }
};
